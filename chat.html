
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alqulol Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, set, push, onChildAdded, onChildRemoved, get, remove, onValue, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
    apiKey: "AIzaSyAPYd3_qq0W9J2rIl5UzPbA9mtuIKkoFOU",
    authDomain: "chat1-9f38d.firebaseapp.com",
    databaseURL: "https://chat1-9f38d-default-rtdb.europe-west1.firebasedatabase.app", // 👈 FIXED
    projectId: "chat1-9f38d",
    storageBucket: "chat1-9f38d.appspot.com", // 👈 make sure this is also fixed
    messagingSenderId: "542146551586",
    appId: "1:542146551586:web:a612a2beb23fb5a8a30f7b",
    measurementId: "G-6P5QDEF8MR"
};


    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentChannel = null;
    let currentUser = null;
    let userData = null;
    let channelData = {};
    let availableChannels = {};

    // Context menu disabled - removed per user request

    // Profile picture upload functionality
    function uploadProfilePicture(file) {
      return new Promise((resolve, reject) => {
        if (!file || !file.type.startsWith('image/')) {
          reject('Please select a valid image file');
          return;
        }

        if (file.size > 5 * 1024 * 1024) { // 5MB limit
          reject('Image size must be less than 5MB');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          resolve(e.target.result);
        };
        reader.onerror = () => reject('Failed to read file');
        reader.readAsDataURL(file);
      });
    }

    // Image upload functionality for messages
    async function handleImageUpload() {
      if (!currentChannel || !currentUser) {
        showNotification('Please join a channel first', 'error');
        return;
      }

      // Check if user is timed out
      const isTimedOut = await checkTimeoutStatus();
      if (isTimedOut) {
        return;
      }

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          try {
            showNotification('Uploading image...', 'info');
            const imageData = await uploadProfilePicture(file);

            // Send image message
            await sendImageMessage(imageData, file.name);
            showNotification('Image uploaded successfully!', 'success');
          } catch (error) {
            showNotification(error, 'error');
          }
        }
      };
      input.click();
    }

    // Send image message to chat
    async function sendImageMessage(imageData, fileName) {
      const messageData = {
        user: currentUser,
        text: `[Image: ${fileName}]`,
        imageData: imageData,
        isImage: true,
        timestamp: Date.now(),
        profilePicture: userData.profilePicture || null
      };

      await push(ref(db, `messages/${currentChannel}`), messageData);
    }

    // Open image in full-screen modal
    function openImageModal(imageData, caption) {
      const modal = document.createElement('div');
      modal.className = 'image-modal';

      // Create elements safely without innerHTML to prevent XSS
      const closeButton = document.createElement('button');
      closeButton.className = 'image-modal-close';
      closeButton.onclick = closeImageModal;
      closeButton.innerHTML = '<i class="fas fa-times"></i>';

      const modalImage = document.createElement('img');
      modalImage.src = imageData;
      modalImage.alt = caption;
      modalImage.className = 'image-modal-content';

      modal.appendChild(closeButton);
      modal.appendChild(modalImage);

      document.body.appendChild(modal);

      // Show modal
      requestAnimationFrame(() => {
        modal.classList.add('show');
      });

      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeImageModal();
        }
      });

      // Close on escape key
      document.addEventListener('keydown', handleImageModalKeydown);
    }

    function closeImageModal() {
      const modal = document.querySelector('.image-modal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
          modal.remove();
        }, 300);
      }
      document.removeEventListener('keydown', handleImageModalKeydown);
    }

    function handleImageModalKeydown(e) {
      if (e.key === 'Escape') {
        closeImageModal();
      }
    }

    async function handleProfilePictureUpload() {
      // Check if user is logged in
      if (!currentUser || !userData) {
        showNotification("Please login to change profile picture", "error");
        switchView("loginView");
        return;
      }

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          try {
            const imageData = await uploadProfilePicture(file);

            // Update user profile picture in database
            if (userData && userData.id) {
              await set(ref(db, `users/${userData.id}/profilePicture`), imageData);
              userData.profilePicture = imageData;
              localStorage.setItem('chatUserData', JSON.stringify(userData));
              updateUserProfile();
              showNotification('Profile picture updated successfully!', 'success');
            }
          } catch (error) {
            showNotification(error, 'error');
          }
        }
      };
      input.click();
    }

    // Check if user is already logged in
    function checkExistingUser() {
      // Reset user interface first
      document.querySelector('.user-name').textContent = "Guest User";
      document.querySelector('.user-role').textContent = "user";
      const avatar = document.querySelector('.user-avatar');
      avatar.style.backgroundImage = '';
      avatar.innerHTML = `<i class="fas fa-user"></i>`;
      document.getElementById("staffDashboardBtn").style.display = "none";
      document.getElementById("channelsList").innerHTML = "";
      
      const storedUserData = localStorage.getItem('chatUserData');
      const storedStaffSession = localStorage.getItem('staffSession');

      // Check for staff session first
      if (storedStaffSession) {
        try {
          const staffData = JSON.parse(storedStaffSession);
          if (staffData.username && staffData.expiresAt > Date.now()) {
            userData = staffData;
            currentUser = staffData.username;
            updateUserProfile();
            checkStaffAccess();
            switchView("welcomeView");
            loadChannelsSidebar();
            return;
          } else {
            // Staff session expired
            localStorage.removeItem('staffSession');
          }
        } catch (error) {
          localStorage.removeItem('staffSession');
        }
      }

      if (storedUserData) {
        try {
          userData = JSON.parse(storedUserData);
          currentUser = userData.username;

          // Verify user still exists in database
          verifyUserExists().then(exists => {
            if (exists) {
              updateUserProfile();
              checkStaffAccess();

              // If user was in a channel, rejoin it
              const storedChannel = localStorage.getItem('currentChannel');
              const storedChannelData = localStorage.getItem('currentChannelData');

              if (storedChannel && storedChannelData) {
                try {
                  currentChannel = storedChannel;
                  channelData = JSON.parse(storedChannelData);
                  rejoinChannelDirectly();
                  return;
                } catch (error) {
                  localStorage.removeItem('currentChannel');
                  localStorage.removeItem('currentChannelData');
                }
              }

              switchView("welcomeView");
              loadChannelsSidebar();
            } else {
              // User doesn't exist anymore, logout
              logout();
            }
          });
        } catch (error) {
          localStorage.removeItem('chatUserData');
          switchView("loginView");
        }
      } else {
        switchView("loginView");
      }
    }

    async function verifyUserExists() {
      try {
        const snapshot = await get(ref(db, `users/${userData.id}`));
        return snapshot.exists();
      } catch (error) {
        return false;
      }
    }

    // Authentication functions
    async function register() {
      const username = document.getElementById("regUsername").value.trim();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;
      const confirmPassword = document.getElementById("regConfirmPassword").value;

      clearAuthErrors();

      if (!validateRegistration(username, email, password, confirmPassword)) {
        return;
      }

      const registerBtn = document.getElementById("registerBtn");
      registerBtn.classList.add("loading");
      registerBtn.disabled = true;

      try {
        // Check if username or email already exists
        const usersSnapshot = await get(ref(db, "users"));
        if (usersSnapshot.exists()) {
          const users = usersSnapshot.val();
          const userExists = Object.values(users).some(user => 
            user.username.toLowerCase() === username.toLowerCase() || 
            user.email.toLowerCase() === email.toLowerCase()
          );

          if (userExists) {
            showAuthError("Username or email already exists");
            return;
          }
        }

        // Create new user
        const userId = Date.now().toString();
        const newUser = {
          id: userId,
          username: username,
          email: email,
          password: hashPassword(password), // In real app, use proper hashing
          role: 'user',
          createdAt: Date.now(),
          lastLogin: Date.now(),
          isActive: true
        };

        await set(ref(db, `users/${userId}`), newUser);

        // Auto login after registration
        userData = newUser;
        currentUser = username;
        localStorage.setItem('chatUserData', JSON.stringify(userData));

        updateUserProfile();
        checkStaffAccess();
        switchView("welcomeView");
        loadChannelsSidebar();
        showNotification("Account created successfully!", "success");

      } catch (error) {
        showAuthError("Registration failed. Please try again.");
      } finally {
        registerBtn.classList.remove("loading");
        registerBtn.disabled = false;
      }
    }

    async function login() {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value;

      clearAuthErrors();

      if (!username || !password) {
        showAuthError("Please fill in all fields");
        return;
      }

      const loginBtn = document.getElementById("loginBtn");
      loginBtn.classList.add("loading");
      loginBtn.disabled = true;

      try {
        const usersSnapshot = await get(ref(db, "users"));
        if (usersSnapshot.exists()) {
          const users = usersSnapshot.val();
          const user = Object.values(users).find(u => 
            u.username.toLowerCase() === username.toLowerCase() && 
            u.password === hashPassword(password) &&
            u.isActive
          );

          if (user) {
            // Check if user is banned
            if (!user.isActive) {
              showAuthError("Your account has been suspended by staff. Please contact administrators for assistance.");
              return;
            }

            // Update last login
            await set(ref(db, `users/${user.id}/lastLogin`), Date.now());

            userData = user;
            currentUser = username;
            localStorage.setItem('chatUserData', JSON.stringify(userData));

            updateUserProfile();
            checkStaffAccess();
            switchView("welcomeView");
            loadChannelsSidebar();
            showNotification(`Welcome back, ${username}!`, "success");
          } else {
            showAuthError("Invalid username or password");
          }
        } else {
          showAuthError("Invalid username or password");
        }
      } catch (error) {
        showAuthError("Login failed. Please try again.");
      } finally {
        loginBtn.classList.remove("loading");
        loginBtn.disabled = false;
      }
    }

    function validateRegistration(username, email, password, confirmPassword) {
      if (!username || !email || !password || !confirmPassword) {
        showAuthError("Please fill in all fields");
        return false;
      }

      if (username.length < 3) {
        showAuthError("Username must be at least 3 characters");
        return false;
      }

      if (username.length > 20) {
        showAuthError("Username must be less than 20 characters");
        return false;
      }

      if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
        showAuthError("Username can only contain letters, numbers, hyphens, and underscores");
        return false;
      }

      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showAuthError("Please enter a valid email address");
        return false;
      }

      if (password.length < 6) {
        showAuthError("Password must be at least 6 characters");
        return false;
      }

      if (password !== confirmPassword) {
        showAuthError("Passwords do not match");
        return false;
      }

      return true;
    }

    function hashPassword(password) {
      // Simple hash for demo - use proper hashing in production
      let hash = 0;
      for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return hash.toString();
    }

    function showAuthError(message) {
      const errorDiv = document.getElementById("authError");
      errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
      errorDiv.style.display = "block";
    }

    function clearAuthErrors() {
      document.getElementById("authError").style.display = "none";
    }

    // Staff credentials (in production, these should be properly secured)
    const STAFF_CREDENTIALS = {
      'admin': { password: 'SecureAdmin2024!', role: 'admin' },
      'moderator': { password: 'ModPass2024!', role: 'moderator' },
      'staffmaster': { password: 'StaffMaster2024!', role: 'admin' }
    };

    function switchAuthMode() {
      const loginForm = document.getElementById("loginForm");
      const registerForm = document.getElementById("registerForm");
      const staffLoginForm = document.getElementById("staffLoginForm");
      const switchText = document.getElementById("authSwitchText");
      const switchLink = document.getElementById("authSwitchLink");
      const staffSwitch = document.getElementById("staffSwitchText");

      if (loginForm.style.display === "none" && registerForm.style.display === "none") {
        // Switch to login from staff
        loginForm.style.display = "block";
        registerForm.style.display = "none";
        staffLoginForm.style.display = "none";
        switchText.textContent = "Don't have an account? ";
        switchLink.textContent = "Sign up";
        staffSwitch.style.display = "block";
        document.getElementById("authTitle").innerHTML = '<i class="fas fa-sign-in-alt"></i> Login to Your Account';
      } else if (loginForm.style.display === "none") {
        // Switch to login from register
        loginForm.style.display = "block";
        registerForm.style.display = "none";
        staffLoginForm.style.display = "none";
        switchText.textContent = "Don't have an account? ";
        switchLink.textContent = "Sign up";
        staffSwitch.style.display = "block";
        document.getElementById("authTitle").innerHTML = '<i class="fas fa-sign-in-alt"></i> Login to Your Account';
      } else {
        // Switch to register
        loginForm.style.display = "none";
        registerForm.style.display = "block";
        staffLoginForm.style.display = "none";
        switchText.textContent = "Already have an account? ";
        switchLink.textContent = "Sign in";
        staffSwitch.style.display = "block";
        document.getElementById("authTitle").innerHTML = '<i class="fas fa-user-plus"></i> Create New Account';
      }
      clearAuthErrors();
    }

    function switchToStaffLogin() {
      const loginForm = document.getElementById("loginForm");
      const registerForm = document.getElementById("registerForm");
      const staffLoginForm = document.getElementById("staffLoginForm");
      const switchText = document.getElementById("authSwitchText");
      const switchLink = document.getElementById("authSwitchLink");
      const staffSwitch = document.getElementById("staffSwitchText");

      loginForm.style.display = "none";
      registerForm.style.display = "none";
      staffLoginForm.style.display = "block";
      switchText.textContent = "Back to user login? ";
      switchLink.textContent = "User Login";
      staffSwitch.style.display = "none";
      document.getElementById("authTitle").innerHTML = '<i class="fas fa-shield-alt"></i> Staff Access Portal';
      clearAuthErrors();
    }

    async function staffLogin() {
      const username = document.getElementById("staffUsername").value.trim();
      const password = document.getElementById("staffPassword").value;

      clearAuthErrors();

      if (!username || !password) {
        showAuthError("Please fill in all fields");
        return;
      }

      const staffLoginBtn = document.getElementById("staffLoginBtn");
      staffLoginBtn.classList.add("loading");
      staffLoginBtn.disabled = true;

      try {
        // Check staff credentials
        const staffAccount = STAFF_CREDENTIALS[username.toLowerCase()];

        if (staffAccount && staffAccount.password === password) {
          // Create staff session (expires in 24 hours)
          const staffSession = {
            id: `staff_${Date.now()}`,
            username: username,
            email: `${username}@staff.simplechat.local`,
            role: staffAccount.role,
            isStaff: true,
            createdAt: Date.now(),
            lastLogin: Date.now(),
            isActive: true,
            expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
          };

          userData = staffSession;
          currentUser = username;
          localStorage.setItem('staffSession', JSON.stringify(staffSession));

          updateUserProfile();
          checkStaffAccess();
          switchView("welcomeView");
          loadChannelsSidebar();
          showNotification(`Welcome, ${username}! Staff access granted.`, "success");
        } else {
          showAuthError("Invalid staff credentials");
        }
      } catch (error) {
        showAuthError("Staff login failed. Please try again.");
      } finally {
        staffLoginBtn.classList.remove("loading");
        staffLoginBtn.disabled = false;
      }
    }

    function logout() {
      localStorage.removeItem('chatUserData');
      localStorage.removeItem('staffSession');
      localStorage.removeItem('currentChannel');
      localStorage.removeItem('currentChannelData');

      // Clear all stored channel passwords
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith('channelPassword_')) {
          localStorage.removeItem(key);
        }
      });

      if (currentChannel && currentUser) {
        setUserOffline();
      }

      currentUser = null;
      userData = null;
      currentChannel = null;
      channelData = {};
      availableChannels = {};
      
      // Reset user profile display
      document.querySelector('.user-name').textContent = "Guest User";
      document.querySelector('.user-role').textContent = "user";
      const avatar = document.querySelector('.user-avatar');
      avatar.style.backgroundImage = '';
      avatar.innerHTML = `<i class="fas fa-user"></i>`;
      
      // Hide staff button
      document.getElementById("staffDashboardBtn").style.display = "none";
      
      // Clear channels list
      document.getElementById("channelsList").innerHTML = "";
      
      switchView("loginView");
      showNotification("Logged out successfully", "info");
    }

    function checkStaffAccess() {
      const staffBtn = document.getElementById("staffDashboardBtn");
      if (userData && (userData.role === 'admin' || userData.role === 'moderator' || userData.isStaff)) {
        staffBtn.style.display = "block";
      } else {
        staffBtn.style.display = "none";
      }
    }

    // Staff Dashboard Functions
    async function openStaffDashboard() {
      // Check if user is logged in first
      if (!currentUser || !userData) {
        showNotification("Please login to access staff dashboard", "error");
        switchView("loginView");
        return;
      }

      if (userData.role !== 'admin' && userData.role !== 'moderator' && !userData.isStaff) {
        showNotification("Access denied", "error");
        return;
      }

      switchView("staffDashboardView");
      loadStaffData();
    }

    async function loadStaffData() {
      await Promise.all([
        loadUsersManagement(),
        loadChannelsManagement(),
        loadSystemStats()
      ]);
    }

    async function loadUsersManagement() {
      const usersList = document.getElementById("usersList");
      usersList.innerHTML = '<div class="loading">Loading users...</div>';

      try {
        const snapshot = await get(ref(db, "users"));
        usersList.innerHTML = "";

        if (snapshot.exists()) {
          const users = snapshot.val();
          Object.values(users).forEach(user => {
            const userItem = document.createElement("div");
            userItem.className = "staff-item";

            const statusClass = user.isActive ? "status-active" : "status-inactive";
            const roleClass = user.role === 'admin' ? "role-admin" : user.role === 'moderator' ? "role-mod" : "role-user";

            userItem.innerHTML = `
              <div class="staff-item-info">
                <div class="staff-item-header">
                  <span class="staff-item-name">${user.username}</span>
                  <span class="staff-item-role ${roleClass}">${user.role}</span>
                  <span class="staff-item-status ${statusClass}">
                    ${user.isActive ? 'Active' : 'Banned'}
                  </span>
                </div>
                <div class="staff-item-details">
                  <span>Email: ${user.email}</span>
                  <span>Joined: ${new Date(user.createdAt).toLocaleDateString()}</span>
                  <span>Last Login: ${new Date(user.lastLogin).toLocaleDateString()}</span>
                </div>
              </div>
              <div class="staff-item-actions">
                ${userData.role === 'admin' ? `
                  <button class="staff-btn ${user.isActive ? 'ban' : 'unban'}" onclick="toggleUserStatus('${user.id}', ${user.isActive})">
                    <i class="fas ${user.isActive ? 'fa-ban' : 'fa-check'}"></i>
                    ${user.isActive ? 'Ban' : 'Unban'}
                  </button>
                  ${user.role !== 'admin' ? `
                    <button class="staff-btn promote" onclick="promoteUser('${user.id}', '${user.role}')">
                      <i class="fas fa-arrow-up"></i>
                      ${user.role === 'user' ? 'Make Mod' : 'Make Admin'}
                    </button>
                  ` : ''}
                  ${user.role !== 'user' ? `
                    <button class="staff-btn demote" onclick="demoteUser('${user.id}', '${user.role}')">
                      <i class="fas fa-arrow-down"></i>
                      ${user.role === 'admin' ? 'To Mod' : 'To User'}
                    </button>
                  ` : ''}
                ` : ''}
                <button class="staff-btn delete" onclick="deleteUser('${user.id}')">
                  <i class="fas fa-trash"></i>
                  Delete
                </button>
              </div>
            `;

            usersList.appendChild(userItem);
          });
        } else {
          usersList.innerHTML = '<div class="no-data">No users found</div>';
        }
      } catch (error) {
        usersList.innerHTML = '<div class="error">Failed to load users</div>';
      }
    }

    async function loadChannelsManagement() {
      const channelsList = document.getElementById("channelsManagementList");
      channelsList.innerHTML = '<div class="loading">Loading channels...</div>';

      try {
        const snapshot = await get(ref(db, "channels"));
        channelsList.innerHTML = "";

        if (snapshot.exists()) {
          const channels = snapshot.val();
          Object.entries(channels).forEach(([name, data]) => {
            const channelItem = document.createElement("div");
            channelItem.className = "staff-item";

            const typeClass = data.isPublic ? "type-public" : "type-private";

            channelItem.innerHTML = `
              <div class="staff-item-info">
                <div class="staff-item-header">
                  <span class="staff-item-name"># ${name}</span>
                  <span class="staff-item-type ${typeClass}">
                    ${data.isPublic ? 'Public' : 'Private'}
                  </span>
                  ${data.isPermanent ? '<span class="status-permanent">Permanent</span>' : ''}
                </div>
                <div class="staff-item-details">
                  <span>Creator: ${data.creator}</span>
                  <span>Created: ${new Date(data.created).toLocaleDateString()}</span>
                  <span>Last Activity: ${new Date(data.lastActivity).toLocaleDateString()}</span>
                </div>
              </div>
              <div class="staff-item-actions">
                <button class="staff-btn view" onclick="staffJoinChannel('${name}')">
                  <i class="fas fa-sign-in-alt"></i>
                  Join Channel
                </button>
                <button class="staff-btn view" onclick="viewChannelMessages('${name}')">
                  <i class="fas fa-eye"></i>
                  View Messages
                </button>
                <button class="staff-btn view" onclick="showChannelMembers('${name}')">
                  <i class="fas fa-users"></i>
                  Members
                </button>
                <button class="staff-btn ${data.securityBot ? 'security-enabled' : 'security'}" onclick="toggleSecurityBot('${name}', ${data.securityBot || false})">
                  <i class="fas fa-robot"></i>
                  ${data.securityBot ? 'Disable Bot' : 'Security Bot'}
                </button>
                <button class="staff-btn ${data.ghostMode ? 'ghost-enabled' : 'ghost'}" onclick="toggleGhostMode('${name}', ${data.ghostMode || false})">
                  <i class="fas fa-ghost"></i>
                  ${data.ghostMode ? 'Ghost Off' : 'Ghost Mode'}
                </button>
                ${!data.isPermanent ? `
                  <button class="staff-btn delete" onclick="deleteChannel('${name}')">
                    <i class="fas fa-trash"></i>
                    Delete
                  </button>
                ` : ''}
              </div>
            `;

            channelsList.appendChild(channelItem);
          });
        } else {
          channelsList.innerHTML = '<div class="no-data">No channels found</div>';
        }
      } catch (error) {
        channelsList.innerHTML = '<div class="error">Failed to load channels</div>';
      }
    }

    async function loadSystemStats() {
      try {
        const [usersSnapshot, channelsSnapshot] = await Promise.all([
          get(ref(db, "users")),
          get(ref(db, "channels"))
        ]);

        const totalUsers = usersSnapshot.exists() ? Object.keys(usersSnapshot.val()).length : 0;
        const activeUsers = usersSnapshot.exists() ? 
          Object.values(usersSnapshot.val()).filter(u => u.isActive).length : 0;
        const totalChannels = channelsSnapshot.exists() ? Object.keys(channelsSnapshot.val()).length : 0;

        document.getElementById("totalUsers").textContent = totalUsers;
        document.getElementById("activeUsers").textContent = activeUsers;
        document.getElementById("totalChannels").textContent = totalChannels;
        document.getElementById("bannedUsers").textContent = totalUsers - activeUsers;
      } catch (error) {
        console.log("Failed to load system stats");
      }
    }

    // Staff Actions
    async function toggleUserStatus(userId, isActive) {
      if (userData.role !== 'admin') {
        showNotification("Access denied", "error");
        return;
      }

      try {
        await set(ref(db, `users/${userId}/isActive`), !isActive);
        loadUsersManagement();
        showNotification(`User ${isActive ? 'banned' : 'unbanned'} successfully`, "success");
      } catch (error) {
        showNotification("Failed to update user status", "error");
      }
    }

    async function promoteUser(userId, currentRole) {
      if (userData.role !== 'admin') {
        showNotification("Access denied", "error");
        return;
      }

      const newRole = currentRole === 'user' ? 'moderator' : 'admin';

      try {
        await set(ref(db, `users/${userId}/role`), newRole);
        loadUsersManagement();
        showNotification(`User promoted to ${newRole}`, "success");
      } catch (error) {
        showNotification("Failed to promote user", "error");
      }
    }

    async function demoteUser(userId, currentRole) {
      if (userData.role !== 'admin') {
        showNotification("Access denied", "error");
        return;
      }

      const newRole = currentRole === 'admin' ? 'moderator' : 'user';

      try {
        await set(ref(db, `users/${userId}/role`), newRole);
        loadUsersManagement();
        showNotification(`User demoted to ${newRole}`, "success");
      } catch (error) {
        showNotification("Failed to demote user", "error");
      }
    }

    // Ghost mode functionality
    async function toggleGhostMode(channelName, currentState) {
      if (userData.role !== 'admin' && userData.role !== 'moderator' && !userData.isStaff) {
        showNotification("Access denied", "error");
        return;
      }

      try {
        const newState = !currentState;
        await set(ref(db, `channels/${channelName}/ghostMode`), newState);

        loadChannelsManagement();
        showNotification(`Ghost mode ${newState ? 'enabled' : 'disabled'} for #${channelName}`, "success");
      } catch (error) {
        showNotification("Failed to toggle ghost mode", "error");
      }
    }

    // Bot Commands System
    const BOT_COMMANDS = {
      '/ban': {
        description: 'Ban a user from the channel',
        usage: '/ban @username [reason]',
        requiresStaff: true,
        execute: async (args, channel) => {
          if (args.length < 1) return 'Usage: /ban @username [reason]';
          const username = args[0].replace('@', '');
          const reason = args.slice(1).join(' ') || 'No reason provided';

          try {
            await set(ref(db, `channels/${channel}/banned/${username}`), {
              reason: reason,
              bannedBy: currentUser,
              timestamp: Date.now()
            });

            // Remove from presence
            await remove(ref(db, `presence/${channel}/${username}`));

            return `🔨 ${username} has been banned from #${channel}. Reason: ${reason}`;
          } catch (error) {
            return '❌ Failed to ban user';
          }
        }
      },
      '/kick': {
        description: 'Kick a user from the channel',
        usage: '/kick @username [reason]',
        requiresStaff: true,
        execute: async (args, channel) => {
          if (args.length < 1) return 'Usage: /kick @username [reason]';
          const username = args[0].replace('@', '');
          const reason = args.slice(1).join(' ') || 'No reason provided';

          try {
            await remove(ref(db, `presence/${channel}/${username}`));

            return `👢 ${username} has been kicked from #${channel}. Reason: ${reason}`;
          } catch (error) {
            return '❌ Failed to kick user';
          }
        }
      },
      '/clear': {
        description: 'Clear messages from the channel',
        usage: '/clear [amount]',
        requiresStaff: true,
        execute: async (args, channel) => {
          const amount = parseInt(args[0]) || 10;
          if (amount > 100) return '❌ Cannot clear more than 100 messages at once';

          try {
            const messagesRef = ref(db, `messages/${channel}`);
            const snapshot = await get(messagesRef);

            if (snapshot.exists()) {
              const messages = snapshot.val();
              const messageKeys = Object.keys(messages).slice(-amount);

              for (const key of messageKeys) {
                await remove(ref(db, `messages/${channel}/${key}`));
              }
            }

            return `🧹 Cleared ${amount} messages from #${channel}`;
          } catch (error) {
            return '❌ Failed to clear messages';
          }
        }
      },
      '/report': {
        description: 'Report a user or message to staff',
        usage: '/report @username [reason]',
        requiresStaff: false,
        execute: async (args, channel) => {
          if (args.length < 1) return 'Usage: /report @username [reason]';
          const username = args[0].replace('@', '');
          const reason = args.slice(1).join(' ') || 'No reason provided';

          try {
            const reportId = Date.now().toString();
            await set(ref(db, `reports/${reportId}`), {
              reportedUser: username,
              reportedBy: currentUser,
              channel: channel,
              reason: reason,
              timestamp: Date.now(),
              status: 'pending'
            });

            return `📋 Report submitted. Staff will review your report about ${username}.`;
          } catch (error) {
            return '❌ Failed to submit report';
          }
        }
      },
      '/mute': {
        description: 'Mute a user in the channel',
        usage: '/mute @username [duration] [reason]',
        requiresStaff: true,
        execute: async (args, channel) => {
          if (args.length < 1) return 'Usage: /mute @username [duration] [reason]';
          const username = args[0].replace('@', '');
          const duration = args[1] || '10m';
          const reason = args.slice(2).join(' ') || 'No reason provided';

          try {
            const muteUntil = Date.now() + (parseDuration(duration) || 600000); // Default 10 minutes

            await set(ref(db, `channels/${channel}/muted/${username}`), {
              mutedBy: currentUser,
              reason: reason,
              muteUntil: muteUntil,
              timestamp: Date.now()
            });

            return `🔇 ${username} has been muted for ${duration}. Reason: ${reason}`;
          } catch (error) {
            return '❌ Failed to mute user';
          }
        }
      },
      '/timeout': {
        description: 'Timeout a user for a specific duration',
        usage: '/timeout @username [duration] [reason]',
        requiresStaff: true,
        execute: async (args, channel) => {
          if (args.length < 1) return 'Usage: /timeout @username [duration] [reason]';
          const username = args[0].replace('@', '');
          const duration = args[1] || '5m';
          const reason = args.slice(2).join(' ') || 'No reason provided';

          try {
            const timeoutUntil = Date.now() + (parseDuration(duration) || 300000); // Default 5 minutes

            await set(ref(db, `channels/${channel}/timeouts/${username}`), {
              timeoutBy: currentUser,
              reason: reason,
              timeoutUntil: timeoutUntil,
              timestamp: Date.now(),
              duration: duration
            });

            // Also add to muted to prevent messaging
            await set(ref(db, `channels/${channel}/muted/${username}`), {
              mutedBy: currentUser,
              reason: `Timeout: ${reason}`,
              muteUntil: timeoutUntil,
              timestamp: Date.now()
            });

            return `⏰ ${username} has been timed out for ${duration}. Reason: ${reason}`;
          } catch (error) {
            return '❌ Failed to timeout user';
          }
        }
      },
      '/untimeout': {
        description: 'Remove timeout from a user',
        usage: '/untimeout @username',
        requiresStaff: true,
        execute: async (args, channel) => {
          if (args.length < 1) return 'Usage: /untimeout @username';
          const username = args[0].replace('@', '');

          try {
            await remove(ref(db, `channels/${channel}/timeouts/${username}`));
            await remove(ref(db, `channels/${channel}/muted/${username}`));
            return `⏰ Timeout removed from ${username}`;
          } catch (error) {
            return '❌ Failed to remove timeout';
          }
        }
      },
      '/unmute': {
        description: 'Unmute a user in the channel',
        usage: '/unmute @username',
        requiresStaff: true,
        execute: async (args, channel) => {
          if (args.length < 1) return 'Usage: /unmute @username';
          const username = args[0].replace('@', '');

          try {
            await remove(ref(db, `channels/${channel}/muted/${username}`));
            return `🔊 ${username} has been unmuted`;
          } catch (error) {
            return '❌ Failed to unmute user';
          }
        }
      },
      '/lock': {
        description: 'Lock the channel (only staff can send messages)',
        usage: '/lock [reason]',
        requiresStaff: true,
        execute: async (args, channel) => {
          const reason = args.join(' ') || 'Channel locked by staff';

          try {
            await set(ref(db, `channels/${channel}/locked`), {
              lockedBy: currentUser,
              reason: reason,
              timestamp: Date.now()
            });

            return `🔒 Channel locked. Reason: ${reason}`;
          } catch (error) {
            return '❌ Failed to lock channel';
          }
        }
      },
      '/unlock': {
        description: 'Unlock the channel',
        usage: '/unlock',
        requiresStaff: true,
        execute: async (args, channel) => {
          try {
            await remove(ref(db, `channels/${channel}/locked`));
            return `🔓 Channel unlocked`;
          } catch (error) {
            return '❌ Failed to unlock channel';
          }
        }
      },
      '/slowmode': {
        description: 'Set slowmode for the channel',
        usage: '/slowmode [seconds]',
        requiresStaff: true,
        execute: async (args, channel) => {
          const seconds = parseInt(args[0]) || 0;

          try {
            if (seconds === 0) {
              await remove(ref(db, `channels/${channel}/slowmode`));
              return '⏱️ Slowmode disabled';
            } else {
              await set(ref(db, `channels/${channel}/slowmode`), {
                seconds: seconds,
                setBy: currentUser,
                timestamp: Date.now()
              });
              return `⏱️ Slowmode set to ${seconds} seconds`;
            }
          } catch (error) {
            return '❌ Failed to set slowmode';
          }
        }
      },
      '/help': {
        description: 'Show available bot commands',
        usage: '/help [command]',
        requiresStaff: false,
        execute: async (args, channel) => {
          if (args.length > 0) {
            const commandName = args[0].startsWith('/') ? args[0] : '/' + args[0];
            const command = BOT_COMMANDS[commandName];
            if (command) {
              return `**${commandName}**\n${command.description}\nUsage: ${command.usage}\nStaff only: ${command.requiresStaff ? 'Yes' : 'No'}`;
            } else {
              return `❌ Command '${commandName}' not found`;
            }
          }

          const isStaff = userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';
          const availableCommands = Object.entries(BOT_COMMANDS)
            .filter(([_, cmd]) => !cmd.requiresStaff || isStaff)
            .map(([name, cmd]) => `**${name}** - ${cmd.description}`)
            .join('\n');

          return `🤖 **Available Commands:**\n${availableCommands}\n\nUse \`/help [command]\` for detailed usage.`;
        }
      }
    };

    function parseDuration(duration) {
      const match = duration.match(/^(\d+)([smhd]?)$/);
      if (!match) return null;

      const value = parseInt(match[1]);
      const unit = match[2] || 's';

      const multipliers = {
        's': 1000,
        'm': 60000,
        'h': 3600000,
        'd': 86400000
      };

      return value * multipliers[unit];
    }

    function showCommandSuggestions(input) {
      if (!input.startsWith('/')) return;

      const isStaff = userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';
      const commands = Object.entries(BOT_COMMANDS)
        .filter(([name, cmd]) => {
          return name.startsWith(input) && (!cmd.requiresStaff || isStaff);
        })
        .slice(0, 8);

      if (commands.length === 0) return;

      // Remove existing suggestions
      const existingSuggestions = document.querySelector('.command-suggestions');
      if (existingSuggestions) {
        existingSuggestions.remove();
      }

      const suggestions = document.createElement('div');
      suggestions.className = 'command-suggestions';
      suggestions.innerHTML = commands.map(([name, cmd]) => `
        <div class="command-suggestion" onclick="selectCommand('${name}')">
          <div class="command-name">${name}</div>
          <div class="command-desc">${cmd.description}</div>
          <div class="command-usage">${cmd.usage}</div>
        </div>
      `).join('');

      const messageInputArea = document.querySelector('.message-input-area');
      messageInputArea.appendChild(suggestions);
    }

    function selectCommand(commandName) {
      const messageInput = document.getElementById('messageInput');
      messageInput.value = commandName + ' ';
      messageInput.focus();

      const suggestions = document.querySelector('.command-suggestions');
      if (suggestions) {
        suggestions.remove();
      }
    }

    async function executeCommand(message) {
      const parts = message.trim().split(' ');
      const commandName = parts[0];
      const args = parts.slice(1);

      const command = BOT_COMMANDS[commandName];
      if (!command) {
        return `❌ Unknown command: ${commandName}. Type /help for available commands.`;
      }

      if (command.requiresStaff && !userData.isStaff && userData.role !== 'admin' && userData.role !== 'moderator') {
        return `❌ You don't have permission to use ${commandName}`;
      }

      try {
        const result = await command.execute(args, currentChannel);
        return result;
      } catch (error) {
        return `❌ Error executing command: ${error.message}`;
      }
    }

    async function deleteUser(userId) {
      if (!confirm("Are you sure you want to delete this user? This action cannot be undone.")) {
        return;
      }

      try {
        await remove(ref(db, `users/${userId}`));
        loadUsersManagement();
        showNotification("User deleted successfully", "success");
      } catch (error) {
        showNotification("Failed to delete user", "error");
      }
    }

    async function deleteChannel(channelName) {
      if (!confirm(`Are you sure you want to delete channel "${channelName}"? This will delete all messages and cannot be undone.`)) {
        return;
      }

      try {
        await Promise.all([
          remove(ref(db, `channels/${channelName}`)),
          remove(ref(db, `messages/${channelName}`)),
          remove(ref(db, `presence/${channelName}`))
        ]);

        loadChannelsManagement();
        showNotification("Channel deleted successfully", "success");
      } catch (error) {
        showNotification("Failed to delete channel", "error");
      }
    }

    async function staffJoinChannel(channelName) {
      if (!userData || (!userData.isStaff && userData.role !== 'admin' && userData.role !== 'moderator')) {
        showNotification("Access denied", "error");
        return;
      }

      try {
        // Get channel data
        const channelSnapshot = await get(ref(db, `channels/${channelName}`));
        if (channelSnapshot.exists()) {
          currentChannel = channelName;
          channelData = channelSnapshot.val();

          // Staff can join any channel without password
          localStorage.setItem('currentChannel', currentChannel);
          localStorage.setItem('currentChannelData', JSON.stringify(channelData));

          switchView("chatView");
          document.getElementById("chatChannelName").innerText = currentChannel;
          document.getElementById("chatWindow").innerHTML = "";

          // Show creator indicator if user owns this channel
          const creatorIndicator = document.getElementById("creatorIndicator");
          const channelDescription = document.getElementById("channelDescription");
          if (channelData && channelData.creator === currentUser) {
            creatorIndicator.style.display = "inline-flex";
            channelDescription.textContent = "Your private channel - You have full moderation powers";
          } else {
            creatorIndicator.style.display = "none";
            channelDescription.textContent = "Secure chat channel";
          }

          // Update activity and presence
          await set(ref(db, `channels/${currentChannel}/lastActivity`), Date.now());
          await set(ref(db, `presence/${currentChannel}/${currentUser}`), {
            status: 'online',
            lastSeen: serverTimestamp(),
            joinedAt: Date.now(),
            isStaff: true
          });

          // Set up automatic offline detection
          await onDisconnect(ref(db, `presence/${currentChannel}/${currentUser}`)).set({
            status: 'offline',
            lastSeen: serverTimestamp(),
            joinedAt: Date.now(),
            isStaff: true
          });

          await set(ref(db, `activeUsers/${currentUser}`), {
            name: currentUser,
            lastActive: Date.now(),
            currentChannel: currentChannel,
            isStaff: true
          });

          // Load messages
          onChildAdded(ref(db, "messages/" + currentChannel), snap => {
            const msg = snap.val();
            // Only add message if user field is valid
            if (msg && msg.user && typeof msg.user === 'string' && msg.user.trim().length > 0) {
              addMessage(msg.user, msg.text, msg.timestamp, snap.key, msg.isBot, msg.profilePicture, msg.imageData, msg.isImage);
            } else {
              console.warn('Skipping message with invalid user:', msg);
            }
          });

          // Listen for message deletions
          onChildRemoved(ref(db, "messages/" + currentChannel), snap => {
            const messageId = snap.key;
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
              messageElement.style.transition = "all 0.3s ease";
              messageElement.style.opacity = "0";
              messageElement.style.transform = "translateX(-100%)";
              messageElement.style.maxHeight = "0";
              messageElement.style.padding = "0";
              messageElement.style.margin = "0";
              setTimeout(() => {
                if (messageElement && messageElement.parentNode) {
                  messageElement.remove();
                }
              }, 300);
            }
          });

          // Listen for timeout changes (when user gets timed out)
          onValue(ref(db, `channels/${currentChannel}/timeouts/${currentUser}`), (snapshot) => {
            setTimeout(checkTimeoutStatus, 100);
          });

          // Listen for mute changes
          onValue(ref(db, `channels/${currentChannel}/muted/${currentUser}`), (snapshot) => {
            setTimeout(checkTimeoutStatus, 100);
          });

          window.addEventListener('beforeunload', setUserOffline);

          showNotification(`Joined #${channelName} as staff`, "success");
        } else {
          showNotification("Channel not found", "error");
        }
      } catch (error) {
        showNotification("Failed to join channel", "error");
      }
    }

    function viewChannelMessages(channelName) {
      // This would open a modal or new view to show channel messages
      showNotification(`Viewing messages for #${channelName}`, "info");
    }

    // Restored viewChannelMembers as a simple wrapper
    async function viewChannelMembers(channelName) {
      await showChannelMembers();
    }

    async function toggleSecurityBot(channelName, currentState) {
      if (userData.role !== 'admin' && userData.role !== 'moderator' && !userData.isStaff) {
        showNotification("Access denied", "error");
        return;
      }

      try {
        const newState = !currentState;
        await set(ref(db, `channels/${channelName}/securityBot`), newState);

        if (newState) {
          // Add security bot features
          await set(ref(db, `channels/${channelName}/securitySettings`), {
            enabled: true,
            commands: true,
            autoMod: true,
            enabledAt: Date.now(),
            enabledBy: currentUser
          });
        } else {
          await remove(ref(db, `channels/${channelName}/securitySettings`));
        }

        loadChannelsManagement();
        showNotification(`Security bot ${newState ? 'enabled' : 'disabled'} for #${channelName}`, "success");
      } catch (error) {
        showNotification("Failed to toggle security bot", "error");
      }
    }

    // Rest of the existing chat functionality remains the same...
    function updateUserProfile() {
      if (currentUser && userData) {
        document.querySelector('.user-name').textContent = currentUser;
        document.querySelector('.user-role').textContent = userData.role;

        const avatar = document.querySelector('.user-avatar');
        if (userData.profilePicture) {
          avatar.style.backgroundImage = `url(${userData.profilePicture})`;
          avatar.style.backgroundSize = 'cover';
          avatar.style.backgroundPosition = 'center';
          avatar.innerHTML = '';
        } else {
          avatar.style.backgroundImage = '';
          avatar.innerHTML = `<i class="fas fa-user"></i>`;
        }
      }
    }

    async function rejoinChannelDirectly() {
      switchView("chatView");
      document.getElementById("chatChannelName").innerText = currentChannel;
      document.getElementById("chatWindow").innerHTML = "";

      // Show creator indicator if user owns this channel
      const creatorIndicator = document.getElementById("creatorIndicator");
      const channelDescription = document.getElementById("channelDescription");
      if (channelData && channelData.creator === currentUser) {
        creatorIndicator.style.display = "inline-flex";
        channelDescription.textContent = "Your private channel - You have full moderation powers";
      } else {
        creatorIndicator.style.display = "none";
        channelDescription.textContent = "Secure chat channel";
      }

      // Initialize members sidebar for rejoins
      startMembersListener();
      initializeMembersSidebar();
      setTimeout(() => {
        loadMembersSidebar();
      }, 1000);

      try {
        await set(ref(db, `channels/${currentChannel}/lastActivity`), Date.now());
        await set(ref(db, `presence/${currentChannel}/${currentUser}`), {
          status: 'online',
          lastSeen: serverTimestamp(),
          joinedAt: Date.now()
        });

        // Set up automatic offline detection
        await onDisconnect(ref(db, `presence/${currentChannel}/${currentUser}`)).set({
          status: 'offline',
          lastSeen: serverTimestamp(),
          joinedAt: Date.now()
        });

        await set(ref(db, `activeUsers/${currentUser}`), {
          name: currentUser,
          lastActive: Date.now(),
          currentChannel: currentChannel
        });

        loadChannelsSidebar();
      } catch (error) {
        console.log("Failed to update activity on rejoin");
        switchView("welcomeView");
        loadChannelsSidebar();
      }

      onChildAdded(ref(db, "messages/" + currentChannel), snap => {
        const msg = snap.val();
        // Only add message if user field is valid
        if (msg && msg.user && typeof msg.user === 'string' && msg.user.trim().length > 0) {
          addMessage(msg.user, msg.text, msg.timestamp, snap.key, msg.isBot, msg.profilePicture, msg.imageData, msg.isImage);
        } else {
          console.warn('Skipping message with invalid user:', msg);
        }
      });

      // Listen for message deletions
      onChildRemoved(ref(db, "messages/" + currentChannel), snap => {
        const messageId = snap.key;
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
          messageElement.style.transition = "all 0.3s ease";
          messageElement.style.opacity = "0";
          messageElement.style.transform = "translateX(-100%)";
          messageElement.style.maxHeight = "0";
          messageElement.style.padding = "0";
          messageElement.style.margin = "0";
          setTimeout(() => {
            if (messageElement && messageElement.parentNode) {
              messageElement.remove();
            }
          }, 300);
        }
      });

      // Listen for timeout changes (when user gets timed out)
      onValue(ref(db, `channels/${currentChannel}/timeouts/${currentUser}`), (snapshot) => {
        setTimeout(checkTimeoutStatus, 100);
      });

      // Listen for mute changes
      onValue(ref(db, `channels/${currentChannel}/muted/${currentUser}`), (snapshot) => {
        setTimeout(checkTimeoutStatus, 100);
      });

      window.addEventListener('beforeunload', setUserOffline);
    }

    // Load channels for sidebar
    async function loadChannelsSidebar() {
      const channelsList = document.getElementById("channelsList");
      channelsList.innerHTML = "";

      try {
        await ensureGeneralChannelExists();

        const snapshot = await get(ref(db, "channels"));
        availableChannels = {};

        if (snapshot.exists()) {
          const channels = snapshot.val();
          availableChannels = channels;

          const generalChannel = channels["General"];
          const otherChannels = Object.keys(channels)
            .filter(name => name !== "General")
            .sort((a, b) => {
              const aTime = channels[a].lastActivity || channels[a].created || 0;
              const bTime = channels[b].lastActivity || channels[b].created || 0;
              return bTime - aTime;
            });

          if (generalChannel) {
            const channelItem = document.createElement("div");
            channelItem.className = "sidebar-channel-item pinned-channel";
            channelItem.onclick = () => showChannelLogin("General", generalChannel);

            channelItem.innerHTML = `
              <div class="channel-icon-small" style="background: linear-gradient(135deg, #10b981, #059669);">
                <i class="fas fa-globe"></i>
              </div>
              <div class="channel-info">
                <span class="channel-name-small">General</span>
                <span class="channel-activity">
                  <i class="fas fa-circle"></i>
                  Public • Pinned
                </span>
              </div>
            `;

            channelsList.appendChild(channelItem);

            if (otherChannels.length > 0) {
              const separator = document.createElement("div");
              separator.className = "channels-separator";
              separator.innerHTML = `<span>Private Channels</span>`;
              channelsList.appendChild(separator);
            }
          }

          otherChannels.forEach((channel) => {
            const data = channels[channel];
            const channelItem = document.createElement("div");
            channelItem.className = "sidebar-channel-item";

            // Staff can access all channels directly
            const isStaff = userData && (userData.isStaff || userData.role === 'admin' || userData.role === 'moderator');

            if (isStaff) {
              channelItem.onclick = () => staffJoinChannel(channel);
            } else {
              channelItem.onclick = () => showChannelLogin(channel, data);
            }

            const hue = Array.from(channel).reduce((acc, char) => acc + char.charCodeAt(0), 0) % 360;
            const lockIcon = isStaff ? 'fa-shield-alt' : 'fa-lock';
            const statusText = isStaff ? 'Private • Staff Access' : 'Private';

            channelItem.innerHTML = `
              <div class="channel-icon-small" style="background: linear-gradient(135deg, hsl(${hue}, 70%, 60%), hsl(${hue + 40}, 70%, 50%));">
                <i class="fas ${lockIcon}"></i>
              </div>
              <div class="channel-info">
                <span class="channel-name-small">${channel}</span>
                <span class="channel-activity">
                  <i class="fas fa-circle"></i>
                  ${statusText}
                </span>
              </div>
            `;

            channelsList.appendChild(channelItem);
          });
        } else {
          await ensureGeneralChannelExists();
          loadChannelsSidebar();
        }
      } catch (error) {
        channelsList.innerHTML = `
          <div class="no-channels error">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Failed to load channels</span>
          </div>
        `;
      }
    }

    async function ensureGeneralChannelExists() {
      try {
        const generalChannel = await get(ref(db, "channels/General"));
        if (!generalChannel.exists()) {
          const now = Date.now();
          await set(ref(db, "channels/General"), {
            password: null,
            isPublic: true,
            created: now,
            lastActivity: now,
            creator: "System",
            isPermanent: true
          });
        }
      } catch (error) {
        console.log("Failed to create General channel");
      }
    }

    function showChannelLogin(channel, data) {
      // Check if user is logged in
      if (!currentUser || !userData) {
        showNotification("Please login to join channels", "error");
        switchView("loginView");
        return;
      }

      currentChannel = channel;
      channelData = data;
      document.getElementById("loginChannelName").innerText = channel;

      // Check if current user is the channel owner - no password needed
      // Compare with normalized usernames for robustness
      if (data.creator && currentUser && 
          data.creator.toLowerCase().trim() === currentUser.toLowerCase().trim()) {
        enterChatDirectly();
        return;
      }

      if (data.isPublic) {
        enterChatDirectly();
      } else {
        // Check if we have a stored password for this channel
        const storedPassword = localStorage.getItem(`channelPassword_${channel}`);
        if (storedPassword && data.password === storedPassword) {
          // Auto-join with stored password
          enterChatDirectly();
        } else {
          // Show password prompt
          switchView("channelLoginView");
          // Pre-fill the password if we have it stored (in case password changed)
          if (storedPassword) {
            document.getElementById("passwordInput").value = storedPassword;
          }
        }
      }
    }

    function createChat() {
      // Check if user is logged in
      if (!currentUser || !userData) {
        showNotification("Please login to create channels", "error");
        switchView("loginView");
        return;
      }

      const modal = document.getElementById("createModal");
      modal.style.display = "flex";
      modal.offsetHeight;
      modal.classList.add("show");
      document.getElementById("newChannelName").focus();
    }

    function closeModal() {
      const modal = document.getElementById("createModal");
      modal.classList.remove("show");
      setTimeout(() => {
        modal.style.display = "none";
        document.getElementById("newChannelName").value = "";
        document.getElementById("newChannelPassword").value = "";
      }, 300);
    }

    async function confirmCreateChat() {
      const name = document.getElementById("newChannelName").value.trim();
      const pass = document.getElementById("newChannelPassword").value;

      if (!name) {
        showNotification("Channel name is required", "error");
        return;
      }

      if (name.length < 3) {
        showNotification("Channel name must be at least 3 characters", "error");
        return;
      }

      if (name.toLowerCase() === "general") {
        showNotification("Cannot create channel with reserved name 'General'", "error");
        return;
      }

      if (!pass) {
        showNotification("Password is required", "error");
        return;
      }

      try {
        const existingChannel = await get(ref(db, "channels/" + name));
        if (existingChannel.exists()) {
          showNotification("Channel name already exists", "error");
          return;
        }

        const now = Date.now();

        await set(ref(db, "channels/" + name), {
          password: pass,
          isPublic: false,
          created: now,
          lastActivity: now,
          creator: currentUser
        });

        closeModal();
        showNotification("Private channel created successfully", "success");
        loadChannelsSidebar();
      } catch (error) {
        showNotification("Channel creation failed", "error");
      }
    }

    async function joinChat() {
      const pass = document.getElementById("passwordInput").value;
      const loadingBtn = document.getElementById("joinButton");

      if (!pass) {
        showNotification("Password required", "error");
        return;
      }

      loadingBtn.classList.add("loading");
      loadingBtn.disabled = true;

      try {
        if (channelData.password === pass) {
          // Store the channel password for future sessions
          localStorage.setItem(`channelPassword_${currentChannel}`, pass);
          enterChatDirectly();
        } else {
          showNotification("Invalid password", "error");
        }
      } catch (error) {
        showNotification("Connection failed", "error");
      } finally {
        loadingBtn.classList.remove("loading");
        loadingBtn.disabled = false;
      }
    }

    async function enterChatDirectly() {
      localStorage.setItem('currentChannel', currentChannel);
      localStorage.setItem('currentChannelData', JSON.stringify(channelData));

      switchView("chatView");
      document.getElementById("chatChannelName").innerText = currentChannel;
      document.getElementById("chatWindow").innerHTML = "";

      // Show creator indicator if user owns this channel
      const creatorIndicator = document.getElementById("creatorIndicator");
      const channelDescription = document.getElementById("channelDescription");
      if (channelData && channelData.creator === currentUser) {
        creatorIndicator.style.display = "inline-flex";
        channelDescription.textContent = "Your private channel - You have full moderation powers";
      } else {
        creatorIndicator.style.display = "none";
        channelDescription.textContent = "Secure chat channel";
      }

      try {
        await set(ref(db, `channels/${currentChannel}/lastActivity`), Date.now());
        // Check if ghost mode is enabled and user is staff
        const channelSnapshot = await get(ref(db, `channels/${currentChannel}`));
        const isGhostMode = channelSnapshot.exists() && channelSnapshot.val().ghostMode;
        const isStaff = userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';

        // Only add to presence if not in ghost mode or user is not staff
        if (!isGhostMode || !isStaff) {
          await set(ref(db, `presence/${currentChannel}/${currentUser}`), {
            status: 'online',
            lastSeen: serverTimestamp(),
            joinedAt: Date.now(),
            isStaff: isStaff,
            ghostMode: isGhostMode && isStaff
          });

          // Set up automatic offline detection
          await onDisconnect(ref(db, `presence/${currentChannel}/${currentUser}`)).set({
            status: 'offline',
            lastSeen: serverTimestamp(),
            joinedAt: Date.now(),
            isStaff: isStaff,
            ghostMode: isGhostMode && isStaff
          });
        } else {
          // For staff in ghost mode, store presence separately
          await set(ref(db, `ghostPresence/${currentChannel}/${currentUser}`), {
            status: 'online',
            lastSeen: serverTimestamp(),
            joinedAt: Date.now(),
            isStaff: true,
            ghostMode: true
          });

          // Set up automatic offline detection for ghost mode
          await onDisconnect(ref(db, `ghostPresence/${currentChannel}/${currentUser}`)).set({
            status: 'offline',
            lastSeen: serverTimestamp(),
            joinedAt: Date.now(),
            isStaff: true,
            ghostMode: true
          });
        }

        await set(ref(db, `activeUsers/${currentUser}`), {
          name: currentUser,
          lastActive: Date.now(),
          currentChannel: currentChannel
        });

        // Listen for member changes and show join/leave notifications
        let previousMembers = new Set();
        let hadInitialSnapshot = false;
        onValue(ref(db, `presence/${currentChannel}`), (snapshot) => {
          updateMemberCount(snapshot);

          // Check for user join/leave events
          const currentMembers = new Set();

          if (snapshot.exists()) {
            const members = snapshot.val();
            Object.entries(members).forEach(([username, data]) => {
              // Only include users who are actually online with recent activity
              if (data.status === 'online') {
                const lastSeen = data.lastSeen;
                if (typeof lastSeen === 'number') {
                  const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
                  if (lastSeen > fiveMinutesAgo) {
                    currentMembers.add(username);
                  }
                } else {
                  // If lastSeen is server timestamp or recent, include them
                  currentMembers.add(username);
                }
              }
            });
          }
          // If snapshot doesn't exist, currentMembers remains empty Set (all users left)

          // Show notifications after initial snapshot (including empty initial state)
          if (hadInitialSnapshot) {
            // Check for new users (joined) - removed notifications per user request
            // currentMembers.forEach(username => {
            //   if (!previousMembers.has(username) && username !== currentUser) {
            //     showUserJoinNotification(username);
            //   }
            // });

            // Check for users who left - removed notifications per user request  
            // previousMembers.forEach(username => {
            //   if (!currentMembers.has(username) && username !== currentUser) {
            //     showUserLeaveNotification(username);
            //   }
            // });
          }

          // Update state for next comparison
          previousMembers = currentMembers;
          hadInitialSnapshot = true;
        });

        // Start checking timeout status
        checkTimeoutStatus();

        // Listen for timeout changes for current user with instant notification
        onValue(ref(db, `channels/${currentChannel}/timeouts/${currentUser}`), (snapshot) => {
          checkTimeoutStatus();
          if (snapshot.exists()) {
            const timeoutData = snapshot.val();
            if (timeoutData.timeoutUntil > Date.now()) {
              showNotification(`You have been timed out by ${timeoutData.timeoutBy}. Reason: ${timeoutData.reason}`, "error");
            }
          }
        });

        // Listen for mute changes for current user
        onValue(ref(db, `channels/${currentChannel}/muted/${currentUser}`), (snapshot) => {
          checkTimeoutStatus();
        });
      } catch (error) {
        console.log("Failed to update activity:", error);
      }

      onChildAdded(ref(db, "messages/" + currentChannel), snap => {
        const msg = snap.val();
        // Only add message if user field is valid
        if (msg && msg.user && typeof msg.user === 'string' && msg.user.trim().length > 0) {
          addMessage(msg.user, msg.text, msg.timestamp, snap.key, msg.isBot, msg.profilePicture, msg.imageData, msg.isImage);
        } else {
          console.warn('Skipping message with invalid user:', msg);
        }
      });

      // Listen for message deletions
      onChildRemoved(ref(db, "messages/" + currentChannel), snap => {
        const messageId = snap.key;
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
          messageElement.style.transition = "all 0.3s ease";
          messageElement.style.opacity = "0";
          messageElement.style.transform = "translateX(-100%)";
          messageElement.style.maxHeight = "0";
          messageElement.style.padding = "0";
          messageElement.style.margin = "0";
          setTimeout(() => {
            if (messageElement && messageElement.parentNode) {
              messageElement.remove();
            }
          }, 300);
        }
      });

      window.addEventListener('beforeunload', setUserOffline);
    }

    function updateMemberCount(snapshot) {
      const memberCountEl = document.getElementById("memberCount");
      if (snapshot.exists()) {
        const members = snapshot.val();
        // Only count users who are explicitly online and have recent activity
        const onlineCount = Object.values(members).filter(m => {
          if (m.status !== 'online') return false;

          // Check if lastSeen is recent (within last 5 minutes) to catch stale connections
          const lastSeen = m.lastSeen;
          if (typeof lastSeen === 'number') {
            const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
            return lastSeen > fiveMinutesAgo;
          }

          // If lastSeen is server timestamp or recent, include them
          return true;
        }).length;
        memberCountEl.textContent = onlineCount;
      } else {
        memberCountEl.textContent = "0";
      }
    }

    async function showChannelMembers() {
      if (!currentChannel) return;

      try {
        const [presenceSnapshot, usersSnapshot, channelSnapshot, timeoutsSnapshot] = await Promise.all([
          get(ref(db, `presence/${currentChannel}`)),
          get(ref(db, 'users')),
          get(ref(db, `channels/${currentChannel}`)),
          get(ref(db, `channels/${currentChannel}/timeouts`))
        ]);

        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.style.display = 'flex';

        let membersList = '<div class="no-data">No members currently in this channel</div>';

        if (presenceSnapshot.exists()) {
          const members = presenceSnapshot.val();
          const users = usersSnapshot.exists() ? usersSnapshot.val() : {};
          const channelData = channelSnapshot.exists() ? channelSnapshot.val() : {};
          const timeouts = timeoutsSnapshot.exists() ? timeoutsSnapshot.val() : {};
          const isSecurityBotEnabled = channelData.securityBot;
          const isGhostMode = channelData.ghostMode;

          let membersArray = Object.entries(members)
            .filter(([username, data]) => {
              // Hide staff members if ghost mode is enabled and current user is not staff
              if (isGhostMode && (data.isStaff || users[data.id]?.role === 'admin' || users[data.id]?.role === 'moderator')) {
                return userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';
              }
              return true;
            })
            .map(([username, data]) => {
              const user = Object.values(users).find(u => u.username === username) || {};
              const userChannelRole = channelData.members && channelData.members[username] ? channelData.members[username].role : 'member';
              const userTimeout = timeouts[username];

              let badges = '';

              // Add creator badge first (highest priority)
              const isChannelCreator = channelData && channelData.creator === username;
              if (isChannelCreator) {
                badges += '<span class="member-badge creator-badge">CREATOR</span>';
              }

              if (data.isStaff || user.role === 'admin' || user.role === 'moderator') {
                badges += '<span class="member-badge staff-badge">OFFICIAL STAFF</span>';
              }

              // Add channel-specific role badge
              if (userChannelRole && userChannelRole !== 'member') {
                const roleColors = {
                  'moderator': 'role-mod-badge',
                  'vip': 'role-vip-badge',
                  'regular': 'role-regular-badge'
                };
                const displayRole = channelData.members[username].roleDisplay || userChannelRole;
                badges += `<span class="member-badge ${roleColors[userChannelRole] || 'role-custom-badge'}">${displayRole.toUpperCase()}</span>`;
              }

              // Add timeout badge
              let timeoutBadge = '';
              let timeoutInfo = '';
              if (userTimeout && userTimeout.timeoutUntil > Date.now()) {
                const timeLeft = Math.ceil((userTimeout.timeoutUntil - Date.now()) / 1000);
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const timeString = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

                // Show timeout info to staff, channel owner, or the user themselves
                const isChannelOwner = channelData && channelData.creator === currentUser;
                const isStaffMember = userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';
                const isCurrentUser = username === currentUser;

                if (isChannelOwner || isStaffMember || isCurrentUser) {
                  timeoutBadge = `<span class="member-badge timeout-badge">TIMED OUT</span>`;
                  timeoutInfo = `
                    <div class="timeout-status">
                      <i class="fas fa-clock"></i>
                      <span class="timeout-time">${timeString} remaining</span>
                      <span class="timeout-reason">Reason: ${userTimeout.reason}</span>
                    </div>
                  `;
                }
              }

              const profilePic = user.profilePicture ? 
                `<div class="member-avatar-img" style="background-image: url(${user.profilePicture})"></div>` :
                `<div class="member-avatar-letter">${username.charAt(0).toUpperCase()}</div>`;

              // Check if current user can moderate this member
              const isChannelOwner = channelData && channelData.creator === currentUser;
              const isStaffMember = userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';
              const canModerate = (isChannelOwner || isStaffMember) && 
                                username !== currentUser && 
                                !(data.isStaff || user.role === 'admin' || user.role === 'moderator');

              // Show different actions based on timeout status and role status
              let moderationActions = '';
              if (canModerate) {
                const hasRole = userChannelRole && userChannelRole !== 'member';

                if (userTimeout && userTimeout.timeoutUntil > Date.now()) {
                  // User is timed out - show role management and remove timeout
                  moderationActions = `
                    <div class="member-quick-actions">
                      ${hasRole ? 
                        `<button class="discord-action-btn remove-role-btn" onclick="removeRole('${username}', '${currentChannel}')">
                          <i class="fas fa-minus"></i>
                          Remove Role
                        </button>` :
                        `<button class="discord-action-btn add-role-btn" onclick="showRoleModal('${username}', '${currentChannel}')">
                          <i class="fas fa-plus"></i>
                          Add Role
                        </button>`
                      }
                      <button class="discord-action-btn remove-timeout-btn" onclick="removeTimeout('${username}', '${currentChannel}')">
                        <i class="fas fa-clock"></i>
                        Remove Timeout
                      </button>
                    </div>
                  `;
                } else {
                  // User is not timed out - show role management and timeout
                  moderationActions = `
                    <div class="member-quick-actions">
                      ${hasRole ? 
                        `<button class="discord-action-btn remove-role-btn" onclick="removeRole('${username}', '${currentChannel}')">
                          <i class="fas fa-minus"></i>
                          Remove Role
                        </button>` :
                        `<button class="discord-action-btn add-role-btn" onclick="showRoleModal('${username}', '${currentChannel}')">
                          <i class="fas fa-plus"></i>
                          Add Role
                        </button>`
                      }
                      <button class="discord-action-btn timeout-btn" onclick="showTimeoutModal('${username}', '${currentChannel}')">
                        <i class="fas fa-clock"></i>
                        Timeout
                      </button>
                    </div>
                  `;
                }
              }

              return {
                html: `
                  <div class="discord-member-card ${canModerate ? 'moderatable' : ''} ${userTimeout && userTimeout.timeoutUntil > Date.now() ? 'timed-out' : ''}">
                    <div class="member-main-info">
                      <div class="member-avatar-container">
                        ${profilePic}
                        <div class="member-status-indicator ${data.status === 'online' ? 'online' : 'offline'}"></div>
                        ${userTimeout && userTimeout.timeoutUntil > Date.now() ? '<div class="timeout-overlay"><i class="fas fa-clock"></i></div>' : ''}
                      </div>
                      <div class="member-text-info">
                        <div class="member-header">
                          <span class="member-name">${username}</span>
                          <div class="member-badges">
                            ${badges}
                            ${timeoutBadge}
                          </div>
                        </div>
                        <div class="member-status-text">
                          ${data.status === 'online' ? 'Online' : `Last seen: ${new Date(data.lastSeen).toLocaleTimeString()}`}
                        </div>
                        ${timeoutInfo}
                      </div>
                    </div>
                    ${moderationActions}
                  </div>
                `,
                isStaff: data.isStaff || user.role === 'admin' || user.role === 'moderator',
                isOnline: data.status === 'online',
                isTimedOut: userTimeout && userTimeout.timeoutUntil > Date.now()
              };
            });

          // Add security bot if enabled
          if (isSecurityBotEnabled) {
            membersArray.unshift({
              html: `
                <div class="discord-member-card bot-member">
                  <div class="member-main-info">
                    <div class="member-avatar-container">
                      <div class="member-avatar-letter bot-avatar">🤖</div>
                      <div class="member-status-indicator online"></div>
                    </div>
                    <div class="member-text-info">
                      <div class="member-header">
                        <span class="member-name">SECURITY</span>
                        <div class="member-badges">
                          <span class="member-badge bot-badge">BOT</span>
                        </div>
                      </div>
                      <div class="member-status-text">Online</div>
                    </div>
                  </div>
                </div>
              `,
              isStaff: false,
              isOnline: true,
              isTimedOut: false
            });
          }

          // Sort: Bots first, then staff, then timed out users, then online users, then offline
          membersArray.sort((a, b) => {
            if (a.html.includes('bot-member') && !b.html.includes('bot-member')) return -1;
            if (!a.html.includes('bot-member') && b.html.includes('bot-member')) return 1;
            if (a.isStaff && !b.isStaff) return -1;
            if (!a.isStaff && b.isStaff) return 1;
            if (a.isTimedOut && !b.isTimedOut) return -1;
            if (!a.isTimedOut && b.isTimedOut) return 1;
            if (a.isOnline && !b.isOnline) return -1;
            if (!a.isOnline && b.isOnline) return 1;
            return 0;
          });

          membersList = membersArray.map(member => member.html).join('');
        }

        modal.innerHTML = `
          <div class="modal-content members-modal">
            <div class="modal-header">
              <h3 class="modal-title">
                <i class="fas fa-users"></i>
                Members — #${currentChannel}
              </h3>
              <p class="modal-subtitle">See who's in this channel</p>
            </div>
            <div class="discord-members-list">
              ${membersList}
            </div>
            <div class="modal-actions">
              <button class="primary-btn" onclick="this.closest('.modal').remove()">Close</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
      } catch (error) {
        showNotification("Failed to load members", "error");
      }
    }

    async function addMessage(user, text, timestamp, messageId, isBot = false, profilePicture = null, imageData = null, isImage = false) {
      const chatWindow = document.getElementById("chatWindow");
      const messageDiv = document.createElement("div");

      // Enhanced safety check for user parameter
      if (!user || typeof user !== 'string') {
        console.error('Invalid user parameter in addMessage:', user);
        return;
      }

      // Ensure user is a valid string and has content
      user = String(user).trim();
      if (!user || user === 'undefined' || user === 'null' || user.length === 0) {
        console.error('Empty or invalid user parameter in addMessage:', user);
        return;
      }

      // Additional safety check to prevent charAt error
      if (user.length < 1) {
        console.error('User parameter too short in addMessage:', user);
        return;
      }

      messageDiv.className = `message ${user === currentUser ? 'own' : 'other'} ${isBot ? 'bot-message' : ''}`;
      messageDiv.setAttribute('data-message-id', messageId);

      const time = timestamp ? new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

      let avatarContent;
      if (isBot) {
        avatarContent = '🤖';
      } else if (profilePicture) {
        avatarContent = `<div class="message-avatar-img" style="background-image: url(${profilePicture}); background-size: cover; background-position: center; width: 100%; height: 100%; border-radius: 50%;"></div>`;
      } else {
        avatarContent = user.charAt(0).toUpperCase();
      }

      let userBadges = '';

      if (isBot) {
        userBadges = '<span class="bot-badge">BOT</span>';
      } else {
        // Add creator badge first (highest priority) - check both availableChannels and channelData
        const isCreator = (availableChannels[currentChannel] && availableChannels[currentChannel].creator === user) ||
                         (channelData && channelData.creator === user);
        if (isCreator) {
          userBadges += '<span class="member-badge creator-badge">CREATOR</span>';
        }

        // Check if user is staff and add badge
        if (userData && userData.isStaff || 
            (availableChannels[currentChannel] && availableChannels[currentChannel].staffUsers && availableChannels[currentChannel].staffUsers.includes(user))) {
          userBadges += '<span class="member-badge staff-badge">OFFICIAL STAFF</span>';
        }

        // Check for channel-specific role
        try {
          if (currentChannel && availableChannels[currentChannel]) {
            const channelSnapshot = await get(ref(db, `channels/${currentChannel}/members/${user}`));
            if (channelSnapshot.exists()) {
              const memberData = channelSnapshot.val();
              const role = memberData.role;

              if (role && role !== 'member') {
                const roleColors = {
                  'moderator': 'role-mod-badge',
                  'vip': 'role-vip-badge', 
                  'regular': 'role-regular-badge'
                };

                const roleClass = roleColors[role] || 'role-custom-badge';
                const displayRole = memberData.roleDisplay || role;
                userBadges += `<span class="member-badge ${roleClass}">${displayRole.toUpperCase()}</span>`;
              }
            }
          }
        } catch (error) {
          console.log('Could not fetch user role for message');
        }
      }

      // Check if current user can delete this message
      const canDelete = canDeleteMessage(user, isBot);
      const deleteButton = canDelete ? `
        <button class="message-delete-btn" onclick="deleteMessage('${messageId}', '${user}')" title="Delete message">
          <i class="fas fa-trash"></i>
        </button>
      ` : '';

      messageDiv.innerHTML = `
        <div class="message-avatar">
          <div class="avatar-circle ${isBot ? 'bot-avatar' : ''}">
            ${avatarContent}
          </div>
        </div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-user">${user}</span>
            <div class="message-badges">${userBadges}</div>
            <span class="message-time">${time}</span>
            ${deleteButton}
          </div>
          <div class="message-text ${isBot ? 'bot-text' : ''}">
            ${isImage && imageData ? 
              `<div class="image-message">
                <img src="${imageData}" alt="${text.replace(/"/g, '&quot;').replace(/'/g, '&#x27;')}" class="chat-image" onclick="openImageModal('${imageData.replace(/'/g, '\\\'').replace(/"/g, '\\"')}', '${text.replace(/'/g, '\\\'').replace(/"/g, '\\"')}')">
                <div class="image-caption">${text.replace('[Image: ', '').replace(']', '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
              </div>` 
              : formatBotMessage(text, isBot)
            }
          </div>
        </div>
      `;

      chatWindow.appendChild(messageDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      messageDiv.style.opacity = "0";
      messageDiv.style.transform = "translateY(20px)";
      requestAnimationFrame(() => {
        messageDiv.style.transition = "all 0.4s cubic-bezier(0.4, 0, 0.2, 1)";
        messageDiv.style.opacity = "1";
        messageDiv.style.transform = "translateY(0)";
      });

      // Auto-remove bot messages after 15 seconds
      if (isBot) {
        setTimeout(() => {
          if (messageDiv && messageDiv.parentNode) {
            messageDiv.style.transition = "all 0.5s ease";
            messageDiv.style.opacity = "0";
            messageDiv.style.transform = "translateY(-20px)";
            setTimeout(() => {
              if (messageDiv && messageDiv.parentNode) {
                messageDiv.remove();
              }
            }, 500);
          }
        }, 15000);
      }
    }

    // Check if current user can delete a message
    function canDeleteMessage(messageUser, isBot) {
      if (!currentUser || !userData) return false;

      // Bot messages cannot be deleted by users
      if (isBot) return false;

      // Users can always delete their own messages
      if (messageUser === currentUser) return true;

      // Channel owner can delete any message
      const isChannelOwner = (channelData && channelData.creator === currentUser) ||
                            (availableChannels[currentChannel] && availableChannels[currentChannel].creator === currentUser);
      if (isChannelOwner) return true;

      // Staff can delete any message
      const isStaff = userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';
      if (isStaff) return true;

      return false;
    }

    // Delete a message
    async function deleteMessage(messageId, messageUser) {
      if (!messageId || !currentChannel) return;

      // Double-check permissions
      if (!canDeleteMessage(messageUser, false)) {
        showNotification("You don't have permission to delete this message", "error");
        return;
      }

      // Show confirmation for deleting other users' messages
      if (messageUser !== currentUser) {
        if (!confirm(`Are you sure you want to delete ${messageUser}'s message?`)) {
          return;
        }
      }

      try {
        // Remove message from Firebase
        await remove(ref(db, `messages/${currentChannel}/${messageId}`));

        // Remove message from UI immediately
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
          messageElement.style.transition = "all 0.3s ease";
          messageElement.style.opacity = "0";
          messageElement.style.transform = "translateX(-100%)";
          setTimeout(() => {
            if (messageElement && messageElement.parentNode) {
              messageElement.remove();
            }
          }, 300);
        }

        // Send bot notification if security bot is enabled and it's not the user's own message
        if (messageUser !== currentUser) {
          const channelSnapshot = await get(ref(db, `channels/${currentChannel}`));
          const isSecurityBotEnabled = channelSnapshot.exists() && channelSnapshot.val().securityBot;

          if (isSecurityBotEnabled) {
            await push(ref(db, `messages/${currentChannel}`), {
              user: "SECURITY",
              text: `🗑️ Message from ${messageUser} was deleted by ${currentUser}`,
              timestamp: Date.now(),
              isBot: true
            });
          }
        }

        showNotification("Message deleted successfully", "success");

      } catch (error) {
        console.error('Error deleting message:', error);
        showNotification("Failed to delete message", "error");
      }
    }

    function formatBotMessage(text, isBot) {
      if (!isBot) return text;

      // Format bot messages with better styling
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');
    }

    // Check if user is currently timed out and update UI
    async function checkTimeoutStatus() {
      if (!currentChannel || !currentUser) return;

      try {
        const timeoutSnapshot = await get(ref(db, `channels/${currentChannel}/timeouts/${currentUser}`));
        const messageInputArea = document.querySelector('.message-input-area');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        // Remove existing timeout indicator
        const existingIndicator = document.querySelector('.timeout-indicator');
        if (existingIndicator) {
          existingIndicator.remove();
        }

        if (timeoutSnapshot.exists()) {
          const timeoutData = timeoutSnapshot.val();
          if (timeoutData.timeoutUntil > Date.now()) {
            const timeLeft = Math.ceil((timeoutData.timeoutUntil - Date.now()) / 1000);
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeString = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

            // Disable input and show timeout message
            messageInput.disabled = true;
            messageInput.placeholder = `You are timed out for ${timeString}. Reason: ${timeoutData.reason}`;
            messageInput.style.background = 'rgba(239, 68, 68, 0.1)';
            messageInput.style.borderColor = 'var(--error)';
            sendButton.disabled = true;
            sendButton.style.opacity = '0.5';

            // Add timeout indicator
            const timeoutIndicator = document.createElement('div');
            timeoutIndicator.className = 'timeout-indicator';
            timeoutIndicator.innerHTML = `
              <i class="fas fa-clock"></i>
              Timed out for ${timeString}
            `;
            messageInputArea.appendChild(timeoutIndicator);

            // Set timer to check again when timeout expires
            setTimeout(checkTimeoutStatus, 1000);
            return true;
          } else {
            // Timeout expired, remove it
            await Promise.all([
              remove(ref(db, `channels/${currentChannel}/timeouts/${currentUser}`)),
              remove(ref(db, `channels/${currentChannel}/muted/${currentUser}`))
            ]);
          }
        }

        // Re-enable input if not timed out
        messageInput.disabled = false;
        messageInput.placeholder = 'Type your message...';
        messageInput.style.background = 'rgba(30, 41, 59, 0.6)';
        messageInput.style.borderColor = 'var(--border)';
        sendButton.disabled = false;
        sendButton.style.opacity = '1';

        return false;
      } catch (error) {
        console.error('Error checking timeout status:', error);
        return false;
      }
    }

    async function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text) return;

      // Check if user is currently timed out
      const isTimedOut = await checkTimeoutStatus();
      if (isTimedOut) {
        return;
      }

      const sendBtn = document.getElementById("sendButton");

      // Clear input immediately for better UX
      input.value = "";
      input.style.height = "56px";

      // Remove command suggestions if any
      const suggestions = document.querySelector('.command-suggestions');
      if (suggestions) {
        suggestions.remove();
      }

      sendBtn.classList.add("sending");

      try {
        // Check if it's a bot command
        if (text.startsWith('/')) {
          const channelSnapshot = await get(ref(db, `channels/${currentChannel}`));
          const isSecurityBotEnabled = channelSnapshot.exists() && channelSnapshot.val().securityBot;

          if (isSecurityBotEnabled) {
            const result = await executeCommand(text);

            // Send bot response
            await push(ref(db, "messages/" + currentChannel), {
              user: "SECURITY",
              text: result,
              timestamp: Date.now(),
              isBot: true
            });

            return;
          } else {
            showNotification("Security bot is not enabled in this channel", "error");
            return;
          }
        }

        // Double-check timeout status before sending
        const [muteSnapshot, timeoutSnapshot] = await Promise.all([
          get(ref(db, `channels/${currentChannel}/muted/${currentUser}`)),
          get(ref(db, `channels/${currentChannel}/timeouts/${currentUser}`))
        ]);

        if (timeoutSnapshot.exists()) {
          const timeoutData = timeoutSnapshot.val();
          if (timeoutData.timeoutUntil > Date.now()) {
            const timeLeft = Math.ceil((timeoutData.timeoutUntil - Date.now()) / 1000);
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeString = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            showNotification(`You are timed out for ${timeString} more. Reason: ${timeoutData.reason}`, "error");
            input.value = text;
            checkTimeoutStatus(); // Update UI
            return;
          } else {
            // Timeout expired, remove it
            await Promise.all([
              remove(ref(db, `channels/${currentChannel}/timeouts/${currentUser}`)),
              remove(ref(db, `channels/${currentChannel}/muted/${currentUser}`))
            ]);
          }
        } else if (muteSnapshot.exists()) {
          const muteData = muteSnapshot.val();
          if (muteData.muteUntil > Date.now()) {
            const timeLeft = Math.ceil((muteData.muteUntil - Date.now()) / 1000);
            showNotification(`You are muted for ${timeLeft} more seconds`, "error");
            input.value = text;
            return;
          } else {
            // Mute expired, remove it
            await remove(ref(db, `channels/${currentChannel}/muted/${currentUser}`));
          }
        }

        // Check if channel is locked
        const lockSnapshot = await get(ref(db, `channels/${currentChannel}/locked`));
        if (lockSnapshot.exists()) {
          const isStaff = userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';
          if (!isStaff) {
            showNotification("Channel is locked. Only staff can send messages.", "error");
            // Restore the text if locked
            input.value = text;
            return;
          }
        }

        // Check slowmode
        const slowmodeSnapshot = await get(ref(db, `channels/${currentChannel}/slowmode`));
        if (slowmodeSnapshot.exists()) {
          const slowmodeData = slowmodeSnapshot.val();
          const lastMessageSnapshot = await get(ref(db, `lastMessage/${currentChannel}/${currentUser}`));

          if (lastMessageSnapshot.exists()) {
            const timeSinceLastMessage = Date.now() - lastMessageSnapshot.val();
            if (timeSinceLastMessage < slowmodeData.seconds * 1000) {
              const timeLeft = Math.ceil((slowmodeData.seconds * 1000 - timeSinceLastMessage) / 1000);
              showNotification(`Slowmode active. Wait ${timeLeft} more seconds`, "error");
              // Restore the text if slowmode active
              input.value = text;
              return;
            }
          }

          await set(ref(db, `lastMessage/${currentChannel}/${currentUser}`), Date.now());
        }

        // Apply bad words filter
        const filteredText = filterBadWords(text);
        
        // If message was blocked entirely, don't send it
        if (filteredText === null) {
          showNotification("Message blocked by content filter", "warning");
          input.value = text; // Restore original message for user to edit
          return;
        }

        // Send message to Firebase with profile picture
        await push(ref(db, "messages/" + currentChannel), {
          user: currentUser,
          text: filteredText,
          timestamp: Date.now(),
          profilePicture: userData?.profilePicture || null
        });

        // Update channel activity
        await set(ref(db, `channels/${currentChannel}/lastActivity`), Date.now());

      } catch (error) {
        showNotification("Message failed to send", "error");
        // Restore the text if failed
        input.value = text;
      } finally {
        sendBtn.classList.remove("sending");
      }
    }

    function switchView(viewName) {
      document.querySelectorAll(".view").forEach(view => {
        view.classList.remove("active");
      });

      setTimeout(() => {
        document.getElementById(viewName).classList.add("active");
      }, 150);
    }

    function showNotification(message, type = "info") {
      const notification = document.createElement("div");
      notification.className = `notification ${type}`;

      let icon = "fas fa-info-circle";
      if (type === "success") icon = "fas fa-check-circle";
      if (type === "error") icon = "fas fa-exclamation-triangle";

      notification.innerHTML = `
        <div class="notification-icon">
          <i class="${icon}"></i>
        </div>
        <div class="notification-content">
          <span>${message}</span>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = "slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards";
        notification.classList.add("show");
      }, 100);

      setTimeout(() => {
        notification.style.animation = "slideOut 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards";
        setTimeout(() => notification.remove(), 400);
      }, 5000);
    }

    // Show notification when a user joins the channel
    function showUserJoinNotification(username) {
      const chatWindow = document.getElementById("chatWindow");
      const joinDiv = document.createElement("div");
      joinDiv.className = "system-message join-message";

      const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

      joinDiv.innerHTML = `
        <div class="system-message-content">
          <i class="fas fa-sign-in-alt" style="color: var(--success);"></i>
          <span class="system-message-text">
            <strong>${username}</strong> joined the channel
          </span>
          <span class="system-message-time">${time}</span>
        </div>
      `;

      chatWindow.appendChild(joinDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      // Animate in
      joinDiv.style.opacity = "0";
      joinDiv.style.transform = "translateY(10px)";
      requestAnimationFrame(() => {
        joinDiv.style.transition = "all 0.3s ease";
        joinDiv.style.opacity = "1";
        joinDiv.style.transform = "translateY(0)";
      });
    }

    // Show notification when a user leaves the channel
    function showUserLeaveNotification(username) {
      const chatWindow = document.getElementById("chatWindow");
      const leaveDiv = document.createElement("div");
      leaveDiv.className = "system-message leave-message";

      const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

      leaveDiv.innerHTML = `
        <div class="system-message-content">
          <i class="fas fa-sign-out-alt" style="color: var(--text-muted);"></i>
          <span class="system-message-text">
            <strong>${username}</strong> left the channel
          </span>
          <span class="system-message-time">${time}</span>
        </div>
      `;

      chatWindow.appendChild(leaveDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      // Animate in
      leaveDiv.style.opacity = "0";
      leaveDiv.style.transform = "translateY(10px)";
      requestAnimationFrame(() => {
        leaveDiv.style.transition = "all 0.3s ease";
        leaveDiv.style.opacity = "1";
        leaveDiv.style.transform = "translateY(0)";
      });
    }

    async function goBack() {
      if (document.getElementById("chatView").classList.contains("active")) {
        await setUserOffline();
        currentChannel = null;
        localStorage.removeItem('currentChannel');
        localStorage.removeItem('currentChannelData');
        switchView("welcomeView");
      } else if (document.getElementById("staffDashboardView").classList.contains("active")) {
        switchView("welcomeView");
      } else {
        switchView("welcomeView");
      }
    }

    async function setUserOffline() {
      if (currentChannel && currentUser) {
        try {
          const isStaff = userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';
          const channelSnapshot = await get(ref(db, `channels/${currentChannel}`));
          const isGhostMode = channelSnapshot.exists() && channelSnapshot.val().ghostMode;

          if (isGhostMode && isStaff) {
            // Remove from ghost presence
            await remove(ref(db, `ghostPresence/${currentChannel}/${currentUser}`));
          } else {
            // Remove from regular presence
            await remove(ref(db, `presence/${currentChannel}/${currentUser}`));
          }

          await remove(ref(db, `activeUsers/${currentUser}`));

          localStorage.removeItem('currentChannel');
          localStorage.removeItem('currentChannelData');
        } catch (error) {
          console.log("Failed to update offline status");
        }
      }
    }

    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    // Load saved theme
    function loadSavedTheme() {
      const savedTheme = localStorage.getItem('selectedTheme') || 'default';
      selectTheme(savedTheme);
    }

    // Event listeners
    document.addEventListener("DOMContentLoaded", () => {
      checkExistingUser();
      loadSavedTheme();

      document.getElementById("passwordInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") joinChat();
      });

      document.getElementById("messageInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          const input = e.target;
          if (input.value.trim()) {
            sendMessage();
          }
        }
      });

      document.getElementById("messageInput").addEventListener("input", (e) => {
        autoResize(e.target);
        showCommandSuggestions(e.target.value);
      });

      document.getElementById("messageInput").addEventListener("blur", (e) => {
        // Delay removal to allow for command selection
        setTimeout(() => {
          const suggestions = document.querySelector('.command-suggestions');
          if (suggestions) {
            suggestions.remove();
          }
        }, 200);
      });

      document.getElementById("newChannelName").addEventListener("keypress", (e) => {
        if (e.key === "Enter") document.getElementById("newChannelPassword").focus();
      });

      document.getElementById("newChannelPassword").addEventListener("keypress", (e) => {
        if (e.key === "Enter") confirmCreateChat();
      });

      // Auth form listeners
      document.getElementById("loginUsername").addEventListener("keypress", (e) => {
        if (e.key === "Enter") document.getElementById("loginPassword").focus();
      });

      document.getElementById("loginPassword").addEventListener("keypress", (e) => {
        if (e.key === "Enter") login();
      });

      document.getElementById("regUsername").addEventListener("keypress", (e) => {
        if (e.key === "Enter") document.getElementById("regEmail").focus();
      });

      document.getElementById("regEmail").addEventListener("keypress", (e) => {
        if (e.key === "Enter") document.getElementById("regPassword").focus();
      });

      document.getElementById("regPassword").addEventListener("keypress", (e) => {
        if (e.key === "Enter") document.getElementById("regConfirmPassword").focus();
      });

      document.getElementById("regConfirmPassword").addEventListener("keypress", (e) => {
        if (e.key === "Enter") register();
      });

      // Staff login listeners
      document.getElementById("staffUsername").addEventListener("keypress", (e) => {
        if (e.key === "Enter") document.getElementById("staffPassword").focus();
      });

      document.getElementById("staffPassword").addEventListener("keypress", (e) => {
        if (e.key === "Enter") staffLogin();
      });

      document.getElementById("createModal").addEventListener("click", (e) => {
        if (e.target === e.currentTarget) closeModal();
      });
      
      // Settings navigation
      document.querySelectorAll('.settings-nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const section = link.getAttribute('data-section');
          switchSettingsSection(section);
        });
      });
      
      // Add Enter key support for bad word input
      document.addEventListener('keypress', (e) => {
        if (e.target.id === 'newBadWord' && e.key === 'Enter') {
          addBadWord();
        }
      });
    });

    // Settings Functions
    function openSettings() {
      // Check if user is logged in
      if (!currentUser || !userData) {
        showNotification("Please login to access settings", "error");
        switchView("loginView");
        return;
      }

      const modal = document.getElementById("settingsModal");
      modal.style.display = "flex";
      modal.offsetHeight;
      modal.classList.add("show");

      // Update admin visibility first
      updateAdminVisibility();

      // Populate current user data
      if (userData) {
        document.getElementById("settingsUsername").value = userData.username || '';
        document.getElementById("settingsEmail").value = userData.email || '';
        document.getElementById("displayName").value = userData.displayName || userData.username || '';
        document.getElementById("statusMessage").value = userData.statusMessage || '';

        // Update avatar preview
        const settingsAvatar = document.getElementById("settingsAvatar");
        if (userData.profilePicture) {
          settingsAvatar.style.backgroundImage = `url(${userData.profilePicture})`;
          settingsAvatar.style.backgroundSize = 'cover';
          settingsAvatar.style.backgroundPosition = 'center';
          settingsAvatar.innerHTML = '';
        } else {
          settingsAvatar.style.backgroundImage = '';
          settingsAvatar.innerHTML = `<i class="fas fa-user"></i>`;
        }
        
        // Load filter settings if admin
        if (userData.role === 'admin' || userData.isStaff) {
          setTimeout(() => {
            const filterActionEl = document.getElementById("filterAction");
            const caseSensitiveEl = document.getElementById("caseSensitive");
            const wholeWordsOnlyEl = document.getElementById("wholeWordsOnly");
            
            if (filterActionEl) filterActionEl.value = badWordsData.settings.filterAction;
            if (caseSensitiveEl) caseSensitiveEl.checked = badWordsData.settings.caseSensitive;
            if (wholeWordsOnlyEl) wholeWordsOnlyEl.checked = badWordsData.settings.wholeWordsOnly;
          }, 100);
        }
      }
    }

    function closeSettings() {
      const modal = document.getElementById("settingsModal");
      modal.classList.remove("show");
      setTimeout(() => {
        modal.style.display = "none";
      }, 300);
    }

    function switchSettingsSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.settings-section').forEach(section => {
        section.classList.remove('active');
      });

      // Remove active from all nav links
      document.querySelectorAll('.settings-nav-link').forEach(link => {
        link.classList.remove('active');
      });

      // Show selected section
      document.getElementById(`${sectionName}-section`).classList.add('active');

      // Add active to selected nav link
      document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
    }

    async function updateAccountInfo() {
      const username = document.getElementById("settingsUsername").value.trim();
      const email = document.getElementById("settingsEmail").value.trim();

      if (!username || !email) {
        showNotification("Please fill in all fields", "error");
        return;
      }

      try {
        // Update user data
        await set(ref(db, `users/${userData.id}/username`), username);
        await set(ref(db, `users/${userData.id}/email`), email);

        userData.username = username;
        userData.email = email;
        currentUser = username;

        localStorage.setItem('chatUserData', JSON.stringify(userData));
        updateUserProfile();

        showNotification("Account information updated successfully!", "success");
      } catch (error) {
        showNotification("Failed to update account information", "error");
      }
    }

    async function updatePassword() {
      const currentPass = document.getElementById("currentPassword").value;
      const newPass = document.getElementById("newPassword").value;
      const confirmPass = document.getElementById("confirmNewPassword").value;

      if (!currentPass || !newPass || !confirmPass) {
        showNotification("Please fill in all password fields", "error");
        return;
      }

      if (newPass !== confirmPass) {
        showNotification("New passwords do not match", "error");
        return;
      }

      if (newPass.length < 6) {
        showNotification("New password must be at least 6 characters", "error");
        return;
      }

      if (hashPassword(currentPass) !== userData.password) {
        showNotification("Current password is incorrect", "error");
        return;
      }

      try {
        await set(ref(db, `users/${userData.id}/password`), hashPassword(newPass));
        userData.password = hashPassword(newPass);
        localStorage.setItem('chatUserData', JSON.stringify(userData));

        // Clear password fields
        document.getElementById("currentPassword").value = '';
        document.getElementById("newPassword").value = '';
        document.getElementById("confirmNewPassword").value = '';

        showNotification("Password updated successfully!", "success");
      } catch (error) {
        showNotification("Failed to update password", "error");
      }
    }

    async function updateProfile() {
      const displayName = document.getElementById("displayName").value.trim();
      const statusMessage = document.getElementById("statusMessage").value.trim();

      try {
        if (displayName) {
          await set(ref(db, `users/${userData.id}/displayName`), displayName);
          userData.displayName = displayName;
        }

        if (statusMessage) {
          await set(ref(db, `users/${userData.id}/statusMessage`), statusMessage);
          userData.statusMessage = statusMessage;
        }

        localStorage.setItem('chatUserData', JSON.stringify(userData));
        updateUserProfile();

        showNotification("Profile updated successfully!", "success");
      } catch (error) {
        showNotification("Failed to update profile", "error");
      }
    }

    async function removeProfilePicture() {
      try {
        await set(ref(db, `users/${userData.id}/profilePicture`), null);
        userData.profilePicture = null;
        localStorage.setItem('chatUserData', JSON.stringify(userData));
        updateUserProfile();

        // Update settings avatar
        const settingsAvatar = document.getElementById("settingsAvatar");
        settingsAvatar.style.backgroundImage = '';
        settingsAvatar.innerHTML = `<i class="fas fa-user"></i>`;

        showNotification("Profile picture removed", "success");
      } catch (error) {
        showNotification("Failed to remove profile picture", "error");
      }
    }

    function selectTheme(themeName) {
      document.querySelectorAll('.theme-circle').forEach(circle => {
        circle.classList.remove('selected');
      });
      document.querySelector(`.theme-${themeName}`).classList.add('selected');

      const root = document.documentElement;

      const themes = {
        default: {
          primary: '#3b82f6', primaryDark: '#2563eb', secondary: '#06b6d4',
          bgPrimary: '#0f172a', bgSecondary: '#1e293b', bgTertiary: '#334155',
          bgCard: '#1e293b', bgGlass: 'rgba(30, 41, 59, 0.6)',
          sidebarBg: '#1a202c', sidebarHover: '#2d3748',
          textPrimary: '#f8fafc', textSecondary: '#cbd5e1', textMuted: '#94a3b8',
          border: '#334155'
        },
        mint: {
          primary: '#10b981', primaryDark: '#059669', secondary: '#6ee7b7',
          bgPrimary: '#064e3b', bgSecondary: '#065f46', bgTertiary: '#047857',
          bgCard: '#065f46', bgGlass: 'rgba(6, 95, 70, 0.6)',
          sidebarBg: '#052e16', sidebarHover: '#064e3b',
          textPrimary: '#ecfdf5', textSecondary: '#a7f3d0', textMuted: '#6ee7b7',
          border: '#047857'
        },
        sunset: {
          primary: '#ea580c', primaryDark: '#c2410c', secondary: '#fb923c',
          bgPrimary: '#7c2d12', bgSecondary: '#9a3412', bgTertiary: '#c2410c',
          bgCard: '#9a3412', bgGlass: 'rgba(154, 52, 18, 0.6)',
          sidebarBg: '#431407', sidebarHover: '#7c2d12',
          textPrimary: '#fff7ed', textSecondary: '#fed7aa', textMuted: '#fb923c',
          border: '#c2410c'
        },
        ocean: {
          primary: '#0ea5e9', primaryDark: '#0284c7', secondary: '#7dd3fc',
          bgPrimary: '#0c4a6e', bgSecondary: '#075985', bgTertiary: '#0369a1',
          bgCard: '#075985', bgGlass: 'rgba(7, 89, 133, 0.6)',
          sidebarBg: '#082f49', sidebarHover: '#0c4a6e',
          textPrimary: '#f0f9ff', textSecondary: '#bae6fd', textMuted: '#7dd3fc',
          border: '#0369a1'
        },
        forest: {
          primary: '#16a34a', primaryDark: '#15803d', secondary: '#4ade80',
          bgPrimary: '#14532d', bgSecondary: '#166534', bgTertiary: '#15803d',
          bgCard: '#166534', bgGlass: 'rgba(22, 101, 52, 0.6)',
          sidebarBg: '#052e16', sidebarHover: '#14532d',
          textPrimary: '#f0fdf4', textSecondary: '#bbf7d0', textMuted: '#4ade80',
          border: '#15803d'
        },
        rose: {
          primary: '#e11d48', primaryDark: '#be123c', secondary: '#fb7185',
          bgPrimary: '#881337', bgSecondary: '#9f1239', bgTertiary: '#be123c',
          bgCard: '#9f1239', bgGlass: 'rgba(159, 18, 57, 0.6)',
          sidebarBg: '#4c0519', sidebarHover: '#881337',
          textPrimary: '#fff1f2', textSecondary: '#fecdd3', textMuted: '#fb7185',
          border: '#be123c'
        },
        lavender: {
          primary: '#9333ea', primaryDark: '#7c3aed', secondary: '#c084fc',
          bgPrimary: '#581c87', bgSecondary: '#6b21a8', bgTertiary: '#7c3aed',
          bgCard: '#6b21a8', bgGlass: 'rgba(107, 33, 168, 0.6)',
          sidebarBg: '#3b0764', sidebarHover: '#581c87',
          textPrimary: '#faf5ff', textSecondary: '#e9d5ff', textMuted: '#c084fc',
          border: '#7c3aed'
        },
        arctic: {
          primary: '#0891b2', primaryDark: '#0e7490', secondary: '#67e8f9',
          bgPrimary: '#ffffff', bgSecondary: '#f0f9ff', bgTertiary: '#e0f2fe',
          bgCard: '#f0f9ff', bgGlass: 'rgba(240, 249, 255, 0.8)',
          sidebarBg: '#ecfeff', sidebarHover: '#e0f2fe',
          textPrimary: '#0c4a6e', textSecondary: '#0369a1', textMuted: '#0891b2',
          border: '#bae6fd'
        },
        warm: {
          primary: '#d97706', primaryDark: '#b45309', secondary: '#fbbf24',
          bgPrimary: '#92400e', bgSecondary: '#a16207', bgTertiary: '#b45309',
          bgCard: '#a16207', bgGlass: 'rgba(161, 98, 7, 0.6)',
          sidebarBg: '#451a03', sidebarHover: '#92400e',
          textPrimary: '#fffbeb', textSecondary: '#fed7aa', textMuted: '#fbbf24',
          border: '#b45309'
        },
        cosmic: {
          primary: '#7c3aed', primaryDark: '#6d28d9', secondary: '#a78bfa',
          bgPrimary: '#4c1d95', bgSecondary: '#5b21b6', bgTertiary: '#6d28d9',
          bgCard: '#5b21b6', bgGlass: 'rgba(91, 33, 182, 0.6)',
          sidebarBg: '#2e1065', sidebarHover: '#4c1d95',
          textPrimary: '#f5f3ff', textSecondary: '#ddd6fe', textMuted: '#a78bfa',
          border: '#6d28d9'
        },
        emerald: {
          primary: '#059669', primaryDark: '#047857', secondary: '#34d399',
          bgPrimary: '#064e3b', bgSecondary: '#065f46', bgTertiary: '#047857',
          bgCard: '#065f46', bgGlass: 'rgba(6, 95, 70, 0.6)',
          sidebarBg: '#022c22', sidebarHover: '#064e3b',
          textPrimary: '#ecfdf5', textSecondary: '#a7f3d0', textMuted: '#34d399',
          border: '#047857'
        },
        volcano: {
          primary: '#dc2626', primaryDark: '#b91c1c', secondary: '#f87171',
          bgPrimary: '#7f1d1d', bgSecondary: '#991b1b', bgTertiary: '#b91c1c',
          bgCard: '#991b1b', bgGlass: 'rgba(153, 27, 27, 0.6)',
          sidebarBg: '#450a0a', sidebarHover: '#7f1d1d',
          textPrimary: '#fef2f2', textSecondary: '#fecaca', textMuted: '#f87171',
          border: '#b91c1c'
        },
        deep: {
          primary: '#1e40af', primaryDark: '#1d4ed8', secondary: '#60a5fa',
          bgPrimary: '#1e1b4b', bgSecondary: '#312e81', bgTertiary: '#3730a3',
          bgCard: '#312e81', bgGlass: 'rgba(49, 46, 129, 0.6)',
          sidebarBg: '#0f0a2e', sidebarHover: '#1e1b4b',
          textPrimary: '#f8fafc', textSecondary: '#c7d2fe', textMuted: '#60a5fa',
          border: '#3730a3'
        },
        autumn: {
          primary: '#78716c', primaryDark: '#57534e', secondary: '#a3a3a3',
          bgPrimary: '#292524', bgSecondary: '#3f3f46', bgTertiary: '#52525b',
          bgCard: '#3f3f46', bgGlass: 'rgba(63, 63, 70, 0.6)',
          sidebarBg: '#1c1917', sidebarHover: '#292524',
          textPrimary: '#fafaf9', textSecondary: '#d6d3d1', textMuted: '#a3a3a3',
          border: '#52525b'
        },
        neon: {
          primary: '#06b6d4', primaryDark: '#0891b2', secondary: '#22d3ee',
          bgPrimary: '#164e63', bgSecondary: '#155e75', bgTertiary: '#0e7490',
          bgCard: '#155e75', bgGlass: 'rgba(21, 94, 117, 0.6)',
          sidebarBg: '#083344', sidebarHover: '#164e63',
          textPrimary: '#f0fdfa', textSecondary: '#a5f3fc', textMuted: '#22d3ee',
          border: '#0e7490'
        }
      };

      const theme = themes[themeName];
      if (theme) {
        root.style.setProperty('--primary', theme.primary);
        root.style.setProperty('--primary-dark', theme.primaryDark);
        root.style.setProperty('--secondary', theme.secondary);
        root.style.setProperty('--bg-primary', theme.bgPrimary);
        root.style.setProperty('--bg-secondary', theme.bgSecondary);
        root.style.setProperty('--bg-tertiary', theme.bgTertiary);
        root.style.setProperty('--bg-card', theme.bgCard);
        root.style.setProperty('--bg-glass', theme.bgGlass);
        root.style.setProperty('--sidebar-bg', theme.sidebarBg);
        root.style.setProperty('--sidebar-hover', theme.sidebarHover);
        root.style.setProperty('--text-primary', theme.textPrimary);
        root.style.setProperty('--text-secondary', theme.textSecondary);
        root.style.setProperty('--text-muted', theme.textMuted);
        root.style.setProperty('--border', theme.border);
      }

      localStorage.setItem('selectedTheme', themeName);
      showNotification(`${themeName.charAt(0).toUpperCase() + themeName.slice(1)} theme selected`, "success");
    }

    function signOutAllDevices() {
      if (confirm("Are you sure you want to sign out all other devices? This action cannot be undone.")) {
        showNotification("All other devices have been signed out", "success");
      }
    }

    // Add event listeners for settings navigation
    document.addEventListener("DOMContentLoaded", () => {
      // Settings navigation
      document.querySelectorAll('.settings-nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const section = link.getAttribute('data-section');
          switchSettingsSection(section);
        });
      });

      // Close settings modal when clicking outside
      document.getElementById("settingsModal").addEventListener("click", (e) => {
        if (e.target === e.currentTarget) closeSettings();
      });
    });

    // Role Modal Functions
    function showRoleModal(username, channelName) {
      const modal = document.createElement('div');
      modal.className = 'modal show role-modal';
      modal.style.display = 'flex';

      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fas fa-user-tag"></i>
              Add Role to User
            </h3>
            <p class="modal-subtitle">Add role to ${username} in #${channelName}</p>
          </div>

          <div class="role-options">
            <h4 style="color: var(--text-primary); margin-bottom: 1rem;">Available Roles:</h4>
            <div class="role-buttons">
              <button class="role-option-btn moderator-role" onclick="assignRole('${username}', '${channelName}', 'moderator')">
                <i class="fas fa-shield-alt"></i>
                <div class="role-info">
                  <span class="role-name">Moderator</span>
                  <span class="role-desc">Can timeout and kick users</span>
                </div>
              </button>
              <button class="role-option-btn vip-role" onclick="assignRole('${username}', '${channelName}', 'vip')">
                <i class="fas fa-star"></i>
                <div class="role-info">
                  <span class="role-name">VIP</span>
                  <span class="role-desc">Special member status</span>
                </div>
              </button>
              <button class="role-option-btn regular-role" onclick="assignRole('${username}', '${channelName}', 'regular')">
                <i class="fas fa-users"></i>
                <div class="role-info">
                  <span class="role-name">Regular</span>
                  <span class="role-desc">Trusted community member</span>
                </div>
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-tag"></i>
              Custom Role Name
            </label>
            <input id="customRoleName" class="form-input" placeholder="Enter custom role name">
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-comment"></i>
              Role Description (Optional)
            </label>
            <input id="roleDescription" class="form-input" placeholder="Brief description of the role">
          </div>

          <div class="modal-actions">
            <button class="secondary-btn" onclick="this.closest('.modal').remove()">Cancel</button>
            <button class="primary-btn" onclick="assignCustomRole('${username}', '${channelName}')">
              <i class="fas fa-plus"></i>
              Add Custom Role
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function assignRole(username, channelName, roleName) {
      try {
        // Check authorization - only channel creators and staff can assign roles
        const channelSnapshot = await get(ref(db, `channels/${channelName}`));
        const channelInfo = channelSnapshot.exists() ? channelSnapshot.val() : null;
        const isChannelCreator = channelInfo && channelInfo.creator === currentUser;
        const isStaffMember = userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';

        if (!isChannelCreator && !isStaffMember) {
          showNotification("You don't have permission to assign roles in this channel", "error");
          return;
        }

        // Initialize channel members structure if it doesn't exist
        const membersRef = ref(db, `channels/${channelName}/members/${username}`);
        await set(membersRef, {
          role: roleName,
          assignedBy: currentUser,
          assignedAt: Date.now()
        });

        // Close the modal without blur effect
        const roleModal = document.querySelector('.role-modal');
        if (roleModal) {
          roleModal.style.opacity = '0';
          setTimeout(() => roleModal.remove(), 300);
        }

        showNotification(`${roleName} role assigned to ${username}!`, "success");

        // Send bot message if security bot is enabled (reuse channelInfo from earlier)
        const isSecurityBotEnabled = channelInfo && channelInfo.securityBot;

        if (isSecurityBotEnabled) {
          await push(ref(db, `messages/${channelName}`), {
            user: "SECURITY",
            text: `🏷️ ${username} has been assigned the **${roleName}** role by ${currentUser}`,
            timestamp: Date.now(),
            isBot: true
          });
        }

        // Refresh the members list after a short delay
        setTimeout(() => {
          showChannelMembers();
        }, 500);
      } catch (error) {
        showNotification("Failed to assign role", "error");
      }
    }

    async function assignCustomRole(username, channelName) {
      const roleName = document.getElementById('customRoleName').value.trim();
      const roleDescription = document.getElementById('roleDescription').value.trim();

      if (!roleName) {
        showNotification("Please enter a role name", "error");
        return;
      }

      if (roleName.length > 20) {
        showNotification("Role name must be 20 characters or less", "error");
        return;
      }

      try {
        await set(ref(db, `channels/${channelName}/members/${username}`), {
          role: roleName.toLowerCase(),
          roleDisplay: roleName,
          description: roleDescription || `Custom role: ${roleName}`,
          assignedBy: currentUser,
          assignedAt: Date.now(),
          isCustom: true
        });

        // Close the modal
        document.querySelector('.role-modal').remove();

        // Close the members modal if it exists
        const membersModal = document.querySelector('.members-modal');
        if (membersModal) {
          membersModal.remove();
        }

        showNotification(`Custom role "${roleName}" assigned to ${username}!`, "success");

        // Send bot message if security bot is enabled
        const channelSnapshotCustom = await get(ref(db, `channels/${channelName}`));
        const isSecurityBotEnabled = channelSnapshotCustom.exists() && channelSnapshotCustom.val().securityBot;

        if (isSecurityBotEnabled) {
          await push(ref(db, `messages/${channelName}`), {
            user: "SECURITY",
            text: `🎨 ${username} has been assigned a custom role: **${roleName}** by ${currentUser}`,
            timestamp: Date.now(),
            isBot: true
          });
        }

        // Refresh the members list after a short delay
        setTimeout(() => {
          if (document.querySelector('.members-modal')) {
            showChannelMembers();
          }
        }, 500);
      } catch (error) {
        showNotification("Failed to assign custom role", "error");
      }
    }

    // Timeout Modal Functions
    function showTimeoutModal(username, channelName) {
      const modal = document.createElement('div');
      modal.className = 'modal show timeout-modal';
      modal.style.display = 'flex';

      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fas fa-clock"></i>
              Timeout User
            </h3>
            <p class="modal-subtitle">Timeout ${username} in #${channelName}</p>
          </div>

          <div class="timeout-options">
            <h4 style="color: var(--text-primary); margin-bottom: 1rem;">Quick Actions:</h4>
            <div class="timeout-buttons">
              <button class="timeout-quick-btn" onclick="applyTimeout('${username}', '${channelName}', '1m', 'Quick timeout')">
                <i class="fas fa-clock"></i>
                1 minute
              </button>
              <button class="timeout-quick-btn" onclick="applyTimeout('${username}', '${channelName}', '5m', 'Short timeout')">
                <i class="fas fa-clock"></i>
                5 minutes
              </button>
              <button class="timeout-quick-btn" onclick="applyTimeout('${username}', '${channelName}', '10m', 'Medium timeout')">
                <i class="fas fa-clock"></i>
                10 minutes
              </button>
              <button class="timeout-quick-btn" onclick="applyTimeout('${username}', '${channelName}', '1h', 'Long timeout')">
                <i class="fas fa-clock"></i>
                1 hour
              </button>
              <button class="timeout-quick-btn" onclick="applyTimeout('${username}', '${channelName}', '24h', 'Extended timeout')">
                <i class="fas fa-clock"></i>
                24 hours
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-clock"></i>
              Custom Duration
            </label>
            <input id="timeoutDuration" class="form-input" placeholder="e.g., 30m, 2h, 1d" value="5m">
            <small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">
              Format: 30s (seconds), 5m (minutes), 2h (hours), 1d (days)
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-comment"></i>
              Reason (Optional)
            </label>
            <input id="timeoutReason" class="form-input" placeholder="Enter reason for timeout">
          </div>

          <div class="modal-actions">
            <button class="secondary-btn" onclick="this.closest('.modal').remove()">Cancel</button>
            <button class="primary-btn" onclick="applyCustomTimeout('${username}', '${channelName}')">
              <i class="fas fa-clock"></i>
              Apply Timeout
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function applyTimeout(username, channelName, duration, reason) {
      try {
        // Check authorization - only channel creators and staff can timeout users
        const channelSnapshot = await get(ref(db, `channels/${channelName}`));
        const channelInfo = channelSnapshot.exists() ? channelSnapshot.val() : null;
        const isChannelCreator = channelInfo && channelInfo.creator === currentUser;
        const isStaffMember = userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';

        if (!isChannelCreator && !isStaffMember) {
          showNotification("You don't have permission to timeout users in this channel", "error");
          return;
        }

        const timeoutUntil = Date.now() + (parseDuration(duration) || 300000);

        await set(ref(db, `channels/${channelName}/timeouts/${username}`), {
          timeoutBy: currentUser,
          reason: reason,
          timeoutUntil: timeoutUntil,
          timestamp: Date.now(),
          duration: duration
        });

        await set(ref(db, `channels/${channelName}/muted/${username}`), {
          mutedBy: currentUser,
          reason: `Timeout: ${reason}`,
          muteUntil: timeoutUntil,
          timestamp: Date.now()
        });

        // Close the modal without blur effect
        const timeoutModal = document.querySelector('.timeout-modal');
        if (timeoutModal) {
          timeoutModal.style.opacity = '0';
          setTimeout(() => timeoutModal.remove(), 300);
        }

        showNotification(`${username} has been timed out for ${duration}`, "success");

        // Send bot message if security bot is enabled
        const channelSnapshotBot = await get(ref(db, `channels/${channelName}`));
        const isSecurityBotEnabled = channelSnapshotBot.exists() && channelSnapshotBot.val().securityBot;

        if (isSecurityBotEnabled) {
          await push(ref(db, `messages/${channelName}`), {
            user: "SECURITY",
            text: `⏰ ${username} has been timed out for ${duration} by ${currentUser}. Reason: ${reason}`,
            timestamp: Date.now(),
            isBot: true
          });
        }

        // If the timed out user is the current user, update their UI
        if (username === currentUser && channelName === currentChannel) {
          setTimeout(checkTimeoutStatus, 500);
        }
      } catch (error) {
        showNotification("Failed to timeout user", "error");
      }
    }

    async function applyCustomTimeout(username, channelName) {
      const duration = document.getElementById('timeoutDuration').value.trim();
      const reason = document.getElementById('timeoutReason').value.trim() || 'No reason provided';

      if (!duration) {
        showNotification("Please enter a timeout duration", "error");
        return;
      }

      const parsedDuration = parseDuration(duration);
      if (!parsedDuration) {
        showNotification("Invalid duration format. Use format like: 30s, 5m, 2h, 1d", "error");
        return;
      }

      await applyTimeout(username, channelName, duration, reason);
    }

    async function removeTimeout(username, channelName) {
      if (!confirm(`Are you sure you want to remove the timeout from ${username}?`)) {
        return;
      }

      try {
        await Promise.all([
          remove(ref(db, `channels/${channelName}/timeouts/${username}`)),
          remove(ref(db, `channels/${channelName}/muted/${username}`))
        ]);

        // Close the members modal if it exists
        const membersModal = document.querySelector('.members-modal');
        if (membersModal) {
          membersModal.remove();
        }

        showNotification(`Timeout removed from ${username}`, "success");

        // Send bot message if security bot is enabled
        const channelSnapshot = await get(ref(db, `channels/${channelName}`));
        const isSecurityBotEnabled = channelSnapshot.exists() && channelSnapshot.val().securityBot;

        if (isSecurityBotEnabled) {
          await push(ref(db, `messages/${channelName}`), {
            user: "SECURITY",
            text: `⏰ Timeout has been removed from ${username} by ${currentUser}`,
            timestamp: Date.now(),
            isBot: true
          });
        }

        // If the user was the current user, update their UI
        if (username === currentUser && channelName === currentChannel) {
          setTimeout(checkTimeoutStatus, 500);
        }

        // Refresh the members list after a short delay
        setTimeout(() => {
          if (!document.querySelector('.members-modal')) {
            showChannelMembers();
          }
        }, 500);
      } catch (error) {
        showNotification("Failed to remove timeout", "error");
      }
    }

    async function removeRole(username, channelName) {
      if (!confirm(`Are you sure you want to remove the role from ${username}?`)) {
        return;
      }

      try {
        // Check authorization - only channel creators and staff can remove roles
        const channelSnapshot = await get(ref(db, `channels/${channelName}`));
        const channelInfo = channelSnapshot.exists() ? channelSnapshot.val() : null;
        const isChannelCreator = channelInfo && channelInfo.creator === currentUser;
        const isStaffMember = userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';

        if (!isChannelCreator && !isStaffMember) {
          showNotification("You don't have permission to remove roles in this channel", "error");
          return;
        }

        // Remove the role by setting it back to 'member'
        const membersRef = ref(db, `channels/${channelName}/members/${username}`);
        await set(membersRef, {
          role: 'member',
          assignedBy: currentUser,
          assignedAt: Date.now()
        });

        // Close any open modals
        const modal = document.querySelector('.role-modal, .members-modal');
        if (modal) {
          modal.remove();
        }

        showNotification(`Role removed from ${username}!`, "success");

        // Send bot message if security bot is enabled (reuse channelInfo from earlier)
        const isSecurityBotEnabled = channelInfo && channelInfo.securityBot;

        if (isSecurityBotEnabled) {
          await push(ref(db, `messages/${channelName}`), {
            user: "SECURITY",
            text: `🏷️ Role removed from ${username} by ${currentUser}`,
            timestamp: Date.now(),
            isBot: true
          });
        }

        // Refresh the members list after a short delay
        setTimeout(() => {
          if (!document.querySelector('.members-modal')) {
            showChannelMembers();
          }
        }, 500);
      } catch (error) {
        showNotification("Failed to remove role", "error");
      }
    }

    async function kickUser(username, channelName) {
      if (!confirm(`Are you sure you want to kick ${username} from #${channelName}?`)) {
        return;
      }

      try {
        await remove(ref(db, `presence/${channelName}/${username}`));

        const membersModal = document.querySelector('.members-modal');
        if (membersModal) {
          membersModal.remove();
        }

        showNotification(`${username} has been kicked from the channel`, "success");

        const channelSnapshot = await get(ref(db, `channels/${channelName}`));
        const isSecurityBotEnabled = channelSnapshot.exists() && channelSnapshot.val().securityBot;

        if (isSecurityBotEnabled) {
          await push(ref(db, `messages/${channelName}`), {
            user: "SECURITY",
            text: `👢 ${username} has been kicked from the channel by ${currentUser}`,
            timestamp: Date.now(),
            isBot: true
          });
        }
      } catch (error) {
        showNotification("Failed to kick user", "error");
      }
    }

    async function banUser(username, channelName) {
      const reason = prompt(`Enter reason for banning ${username}:`) || 'No reason provided';

      if (!confirm(`Are you sure you want to ban ${username} from #${channelName}?`)) {
        return;
      }

      try {
        await set(ref(db, `channels/${channelName}/banned/${username}`), {
          reason: reason,
          bannedBy: currentUser,
          timestamp: Date.now()
        });

        await remove(ref(db, `presence/${channelName}/${username}`));

        const membersModal = document.querySelector('.members-modal');
        if (membersModal) {
          membersModal.remove();
        }

        showNotification(`${username} has been banned from the channel`, "success");

        const channelSnapshot = await get(ref(db, `channels/${channelName}`));
        const isSecurityBotEnabled = channelSnapshot.exists() && channelSnapshot.val().securityBot;

        if (isSecurityBotEnabled) {
          await push(ref(db, `messages/${channelName}`), {
            user: "SECURITY",
            text: `🔨 ${username} has been banned from the channel by ${currentUser}. Reason: ${reason}`,
            timestamp: Date.now(),
            isBot: true
          });
        }
      } catch (error) {
        showNotification("Failed to ban user", "error");
      }
    }

    // Members Sidebar Functions
    let membersSidebarOpen = true; // Always open by default

    function initializeMembersSidebar() {
      const sidebar = document.getElementById('membersSidebar');
      const chatMain = document.querySelector('.chat-main');

      // Always show members sidebar
      sidebar.classList.add('open');
      chatMain.classList.add('members-open');
      loadMembersSidebar();
    }

    async function loadMembersSidebar() {
      if (!currentChannel) return;

      const membersList = document.getElementById('membersListSidebar');
      const membersCount = document.getElementById('membersCount');

      membersList.innerHTML = '<div class="members-loading">Loading members...</div>';

      try {
        const [presenceSnapshot, usersSnapshot, channelSnapshot, timeoutsSnapshot] = await Promise.all([
          get(ref(db, `presence/${currentChannel}`)),
          get(ref(db, 'users')),
          get(ref(db, `channels/${currentChannel}`)),
          get(ref(db, `channels/${currentChannel}/timeouts`))
        ]);

        membersList.innerHTML = "";

        if (presenceSnapshot.exists()) {
          const members = presenceSnapshot.val();
          const users = usersSnapshot.exists() ? usersSnapshot.val() : {};
          const channelData = channelSnapshot.exists() ? channelSnapshot.val() : {};
          const timeouts = timeoutsSnapshot.exists() ? timeoutsSnapshot.val() : {};
          const isSecurityBotEnabled = channelData.securityBot;
          const isGhostMode = channelData.ghostMode;

          // Categorize members
          const bots = [];
          const staff = [];
          const timedOut = [];
          const online = [];
          const offline = [];

          // Add security bot if enabled
          if (isSecurityBotEnabled) {
            bots.push({
              username: 'SECURITY',
              isBot: true,
              status: 'online',
              activity: 'Monitoring channel'
            });
          }

          // Process real members
          Object.entries(members)
            .filter(([username, data]) => {
              // Hide staff members if ghost mode is enabled and current user is not staff
              if (isGhostMode && (data.isStaff || users[data.id]?.role === 'admin' || users[data.id]?.role === 'moderator')) {
                return userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';
              }
              return true;
            })
            .forEach(([username, data]) => {
              const user = Object.values(users).find(u => u.username === username) || {};
              const userChannelRole = channelData.members && channelData.members[username] ? channelData.members[username].role : 'member';
              const userTimeout = timeouts[username];
              const isStaff = data.isStaff || user.role === 'admin' || user.role === 'moderator';
              const isTimedOut = userTimeout && userTimeout.timeoutUntil > Date.now();

              const memberData = {
                username,
                user,
                data,
                userChannelRole,
                userTimeout,
                isStaff,
                isTimedOut,
                profilePicture: user.profilePicture
              };

              if (isTimedOut) {
                timedOut.push(memberData);
              } else if (isStaff) {
                staff.push(memberData);
              } else if (data.status === 'online') {
                online.push(memberData);
              } else {
                offline.push(memberData);
              }
            });

          // Create member sections
          if (bots.length > 0) {
            createMemberCategory('Bots', bots.length, membersList);
            bots.forEach(bot => {
              const memberItem = createMemberSidebarItem(bot);
              membersList.appendChild(memberItem);
            });
          }

          if (staff.length > 0) {
            createMemberCategory('Staff', staff.length, membersList);
            staff.forEach(member => {
              const memberItem = createMemberSidebarItem(member);
              membersList.appendChild(memberItem);
            });
          }

          if (timedOut.length > 0) {
            createMemberCategory('Timed Out', timedOut.length, membersList);
            timedOut.forEach(member => {
              const memberItem = createMemberSidebarItem(member);
              membersList.appendChild(memberItem);
            });
          }

          if (online.length > 0) {
            createMemberCategory('Online', online.length, membersList);
            online.forEach(member => {
              const memberItem = createMemberSidebarItem(member);
              membersList.appendChild(memberItem);
            });
          }

          if (offline.length > 0) {
            createMemberCategory('Offline', offline.length, membersList);
            offline.forEach(member => {
              const memberItem = createMemberSidebarItem(member);
              membersList.appendChild(memberItem);
            });
          }

          const totalMembers = bots.length + staff.length + timedOut.length + online.length + offline.length;
          membersCount.textContent = totalMembers;

        } else {
          membersList.innerHTML = '<div class="members-empty">No members in this channel</div>';
          membersCount.textContent = '0';
        }
      } catch (error) {
        membersList.innerHTML = '<div class="members-empty">Failed to load members</div>';
        membersCount.textContent = '—';
      }
    }

    function createMemberCategory(title, count, container) {
      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'member-category';
      categoryDiv.innerHTML = `
        <div class="member-category-header">
          <span>${title}</span>
          <span class="member-category-count">${count}</span>
        </div>
      `;
      container.appendChild(categoryDiv);
    }

    function createMemberSidebarItem(memberData) {
      const isBot = memberData.isBot;
      const username = memberData.username;
      const user = memberData.user || {};
      const data = memberData.data || {};
      const userChannelRole = memberData.userChannelRole;
      const userTimeout = memberData.userTimeout;
      const isStaff = memberData.isStaff;
      const isTimedOut = memberData.isTimedOut;
      const profilePicture = memberData.profilePicture;

      const memberItem = document.createElement('div');
      memberItem.className = `member-sidebar-item ${isBot ? 'bot-member' : ''} ${isStaff ? 'staff-member' : ''} ${isTimedOut ? 'timed-out' : ''}`;

      let avatarContent;
      if (isBot) {
        avatarContent = `<div class="member-sidebar-avatar-letter">🤖</div>`;
      } else if (profilePicture) {
        avatarContent = `<div class="member-sidebar-avatar-img" style="background-image: url(${profilePicture})"></div>`;
      } else {
        avatarContent = `<div class="member-sidebar-avatar-letter">${username.charAt(0).toUpperCase()}</div>`;
      }

      let badges = '';
      let activity = '';

      if (isBot) {
        badges = '<span class="member-sidebar-badge bot">BOT</span>';
        activity = memberData.activity || 'Online';
      } else {
        if (isStaff) {
          badges += '<span class="member-sidebar-badge staff">STAFF</span>';
        }

        if (userChannelRole && userChannelRole !== 'member') {
          const roleColors = {
            'moderator': 'mod',
            'vip': 'vip',
            'regular': 'regular'
          };
          const roleClass = roleColors[userChannelRole] || 'mod';
          const displayRole = channelData.members && channelData.members[username] ? channelData.members[username].roleDisplay || userChannelRole : userChannelRole;
          badges += `<span class="member-sidebar-badge ${roleClass}">${displayRole.toUpperCase()}</span>`;
        }

        if (isTimedOut) {
          badges += '<span class="member-sidebar-badge timeout">TIMEOUT</span>';
          const timeLeft = Math.ceil((userTimeout.timeoutUntil - Date.now()) / 1000);
          const minutes = Math.floor(timeLeft / 60);
          const seconds = timeLeft % 60;
          const timeString = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
          activity = `Timed out for ${timeString}`;
        } else {
          activity = data.status === 'online' ? 'Online' : `Last seen: ${new Date(data.lastSeen || Date.now()).toLocaleTimeString()}`;
        }
      }

      // Check if current user can moderate this member
      const isChannelOwner = channelData && channelData.creator === currentUser;
      const isStaffMember = userData.isStaff || userData.role === 'admin' || userData.role === 'moderator';
      const canModerate = (isChannelOwner || isStaffMember) && 
                        username !== currentUser && 
                        !isBot &&
                        !(data.isStaff || user.role === 'admin' || user.role === 'moderator');

      let moderationActions = '';
      if (canModerate) {
        if (isTimedOut) {
          moderationActions = `
            <div class="member-moderation-actions">
              <button class="member-mod-btn" onclick="showRoleModal('${username}', '${currentChannel}')">
                <i class="fas fa-plus"></i>
                Role
              </button>
              <button class="member-mod-btn remove-timeout" onclick="removeTimeout('${username}', '${currentChannel}')">
                <i class="fas fa-clock"></i>
                Remove
              </button>
            </div>
          `;
        } else {
          moderationActions = `
            <div class="member-moderation-actions">
              <button class="member-mod-btn" onclick="showRoleModal('${username}', '${currentChannel}')">
                <i class="fas fa-plus"></i>
                Role
              </button>
              <button class="member-mod-btn timeout" onclick="showTimeoutModal('${username}', '${currentChannel}')">
                <i class="fas fa-clock"></i>
                Timeout
              </button>
            </div>
          `;
        }
      }

      memberItem.innerHTML = `
        <div class="member-sidebar-main">
          <div class="member-sidebar-avatar ${isBot ? 'bot' : ''}">
            ${avatarContent}
            <div class="member-sidebar-status ${data.status || 'online'}"></div>
            ${isTimedOut ? '<div class="member-timeout-indicator"><i class="fas fa-clock"></i></div>' : ''}
          </div>
          <div class="member-sidebar-info">
            <div class="member-sidebar-name">${username}</div>
            <div class="member-sidebar-activity">${activity}</div>
            <div class="member-sidebar-badges">${badges}</div>
          </div>
          ${moderationActions}
        </div>
      `;

      return memberItem;
    }

    // Listen for member changes when in chat
    function startMembersListener() {
      if (!currentChannel) return;

      // Listen to presence changes
      onValue(ref(db, `presence/${currentChannel}`), (snapshot) => {
        updateMemberCount(snapshot);
        if (membersSidebarOpen) {
          loadMembersSidebar();
        }
      });

      // Listen to timeout changes for real-time member list updates
      onValue(ref(db, `channels/${currentChannel}/timeouts`), (snapshot) => {
        if (membersSidebarOpen) {
          loadMembersSidebar();
        }
      });

      // Listen to mute changes for real-time member list updates
      onValue(ref(db, `channels/${currentChannel}/muted`), (snapshot) => {
        if (membersSidebarOpen) {
          loadMembersSidebar();
        }
      });

      // Listen to channel data changes (roles, etc.) for real-time member list updates
      onValue(ref(db, `channels/${currentChannel}`), (snapshot) => {
        if (membersSidebarOpen) {
          loadMembersSidebar();
        }
      });

      // Listen to user data changes for real-time member list updates
      onValue(ref(db, 'users'), (snapshot) => {
        if (membersSidebarOpen) {
          loadMembersSidebar();
        }
      });
    }

    // Update enterChatDirectly to start members listener and open sidebar
    const originalEnterChatDirectly = enterChatDirectly;
    enterChatDirectly = async function() {
      await originalEnterChatDirectly.call(this);
      startMembersListener();
      initializeMembersSidebar();
      // Force refresh after delay to ensure members show up
      setTimeout(() => {
        loadMembersSidebar();
      }, 1000);
    };

    // Bad Words Moderation System
    let badWordsData = {
      words: ['gheen'], // Default bad words
      settings: {
        filterAction: 'replace',
        caseSensitive: false,
        wholeWordsOnly: true
      },
      stats: {
        filteredToday: 0,
        filteredTotal: 0,
        lastResetDate: new Date().toDateString()
      }
    };

    // Load bad words from database
    async function loadBadWordsData() {
      try {
        const snapshot = await get(ref(db, 'moderation/badWords'));
        if (snapshot.exists()) {
          badWordsData = { ...badWordsData, ...snapshot.val() };
        }
        
        // Load settings from localStorage as backup
        const localSettings = localStorage.getItem('badWordsSettings');
        if (localSettings) {
          badWordsData.settings = { ...badWordsData.settings, ...JSON.parse(localSettings) };
        }
        
        updateBadWordsDisplay();
        updateModerationStats();
      } catch (error) {
        console.error('Failed to load bad words:', error);
      }
    }

    // Save bad words to database
    async function saveBadWordsData() {
      try {
        await set(ref(db, 'moderation/badWords'), badWordsData);
        localStorage.setItem('badWordsSettings', JSON.stringify(badWordsData.settings));
      } catch (error) {
        console.error('Failed to save bad words:', error);
        showNotification('Failed to save moderation settings', 'error');
      }
    }

    // Add new bad word
    async function addBadWord() {
      const input = document.getElementById('newBadWord');
      const word = input.value.trim().toLowerCase();
      
      if (!word) {
        showNotification('Please enter a word to filter', 'warning');
        return;
      }
      
      if (word.length > 50) {
        showNotification('Word is too long (max 50 characters)', 'warning');
        return;
      }
      
      if (badWordsData.words.includes(word)) {
        showNotification('This word is already in the filter list', 'warning');
        return;
      }
      
      badWordsData.words.push(word);
      input.value = '';
      
      await saveBadWordsData();
      updateBadWordsDisplay();
      updateModerationStats();
      showNotification('Bad word added successfully', 'success');
    }

    // Remove bad word
    async function removeBadWord(word) {
      if (!confirm(`Remove "${word}" from the bad words filter?`)) return;
      
      badWordsData.words = badWordsData.words.filter(w => w !== word);
      await saveBadWordsData();
      updateBadWordsDisplay();
      updateModerationStats();
      showNotification('Bad word removed', 'success');
    }

    // Update bad words display
    function updateBadWordsDisplay() {
      const container = document.getElementById('badWordsList');
      const countElement = document.getElementById('badWordsCount');
      
      if (!container) return;
      
      countElement.textContent = badWordsData.words.length;
      
      if (badWordsData.words.length === 0) {
        container.innerHTML = '<div class="bad-words-empty">No bad words in filter list</div>';
        return;
      }
      
      container.innerHTML = badWordsData.words.map(word => `
        <div class="bad-word-item">
          <span class="bad-word-text">${word}</span>
          <button class="bad-word-remove" onclick="removeBadWord('${word}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('');
    }

    // Save filter settings
    async function saveFilterSettings() {
      badWordsData.settings = {
        filterAction: document.getElementById('filterAction').value,
        caseSensitive: document.getElementById('caseSensitive').checked,
        wholeWordsOnly: document.getElementById('wholeWordsOnly').checked
      };
      
      await saveBadWordsData();
      showNotification('Filter settings saved', 'success');
    }

    // Filter message for bad words
    function filterBadWords(message) {
      if (!message || badWordsData.words.length === 0) return message;
      
      let filteredMessage = message;
      let wasFiltered = false;
      
      badWordsData.words.forEach(badWord => {
        let regex;
        const flags = badWordsData.settings.caseSensitive ? 'g' : 'gi';
        
        if (badWordsData.settings.wholeWordsOnly) {
          regex = new RegExp(`\\\\b${badWord}\\\\b`, flags);
        } else {
          regex = new RegExp(badWord, flags);
        }
        
        if (regex.test(filteredMessage)) {
          wasFiltered = true;
          
          switch (badWordsData.settings.filterAction) {
            case 'replace':
              filteredMessage = filteredMessage.replace(regex, '*'.repeat(badWord.length));
              break;
            case 'remove':
              filteredMessage = filteredMessage.replace(regex, '');
              break;
            case 'block':
              return null; // Block entire message
          }
        }
      });
      
      if (wasFiltered) {
        updateModerationStats(true);
      }
      
      return filteredMessage;
    }

    // Update moderation stats
    function updateModerationStats(increment = false) {
      if (increment) {
        const today = new Date().toDateString();
        if (badWordsData.stats.lastResetDate !== today) {
          badWordsData.stats.filteredToday = 0;
          badWordsData.stats.lastResetDate = today;
        }
        badWordsData.stats.filteredToday++;
        badWordsData.stats.filteredTotal++;
        saveBadWordsData();
      }
      
      const filteredTodayEl = document.getElementById('filteredToday');
      const filteredTotalEl = document.getElementById('filteredTotal');
      const totalBadWordsEl = document.getElementById('totalBadWords');
      
      if (filteredTodayEl) filteredTodayEl.textContent = badWordsData.stats.filteredToday;
      if (filteredTotalEl) filteredTotalEl.textContent = badWordsData.stats.filteredTotal;
      if (totalBadWordsEl) totalBadWordsEl.textContent = badWordsData.words.length;
    }

    // Reset moderation stats
    async function resetModerationStats() {
      if (!confirm('Reset all moderation statistics? This cannot be undone.')) return;
      
      badWordsData.stats = {
        filteredToday: 0,
        filteredTotal: 0,
        lastResetDate: new Date().toDateString()
      };
      
      await saveBadWordsData();
      updateModerationStats();
      showNotification('Moderation statistics reset', 'success');
    }

    // Show admin sections only for admins
    function updateAdminVisibility() {
      const isAdmin = userData && (userData.role === 'admin' || userData.isStaff);
      const adminElements = document.querySelectorAll('.admin-only');
      
      adminElements.forEach(element => {
        if (isAdmin) {
          element.style.display = '';
          element.classList.remove('admin-only');
        } else {
          element.style.display = 'none';
          element.classList.add('admin-only');
        }
      });
      
      if (isAdmin) {
        loadBadWordsData();
      }
    }

    // Expose functions globally
    window.createChat = createChat;
    window.closeModal = closeModal;
    window.confirmCreateChat = confirmCreateChat;
    window.joinChat = joinChat;
    window.sendMessage = sendMessage;
    window.goBack = goBack;
    window.loadChannelsSidebar = loadChannelsSidebar;
    window.login = login;
    window.register = register;
    window.switchAuthMode = switchAuthMode;
    window.switchToStaffLogin = switchToStaffLogin;
    window.staffLogin = staffLogin;
    window.logout = logout;
    window.openStaffDashboard = openStaffDashboard;
    window.toggleUserStatus = toggleUserStatus;
    window.promoteUser = promoteUser;
    window.deleteUser = deleteUser;
    window.deleteChannel = deleteChannel;
    window.viewChannelMessages = viewChannelMessages;
    window.viewChannelMembers = viewChannelMembers;
    window.toggleSecurityBot = toggleSecurityBot;
    window.showChannelMembers = showChannelMembers;
    window.demoteUser = demoteUser;
    window.staffJoinChannel = staffJoinChannel;
    window.toggleGhostMode = toggleGhostMode;
    window.handleProfilePictureUpload = handleProfilePictureUpload;
    window.selectCommand = selectCommand;
    window.openSettings = openSettings;
    window.closeSettings = closeSettings;
    window.switchSettingsSection = switchSettingsSection;
    window.updateAccountInfo = updateAccountInfo;
    window.updatePassword = updatePassword;
    window.updateProfile = updateProfile;
    window.removeProfilePicture = removeProfilePicture;
    window.selectTheme = selectTheme;
    window.signOutAllDevices = signOutAllDevices;
    window.showTimeoutModal = showTimeoutModal;
    window.applyTimeout = applyTimeout;
    window.applyCustomTimeout = applyCustomTimeout;
    window.kickUser = kickUser;
    window.banUser = banUser;
    window.showRoleModal = showRoleModal;
    window.assignRole = assignRole;
    window.assignCustomRole = assignCustomRole;
    window.checkTimeoutStatus = checkTimeoutStatus;
    window.removeTimeout = removeTimeout;
    window.removeRole = removeRole;
    window.initializeMembersSidebar = initializeMembersSidebar;
    window.loadMembersSidebar = loadMembersSidebar;
    window.handleImageUpload = handleImageUpload;
    window.openImageModal = openImageModal;
    window.closeImageModal = closeImageModal;
    window.deleteMessage = deleteMessage;
    window.addBadWord = addBadWord;
    window.removeBadWord = removeBadWord;
    window.saveFilterSettings = saveFilterSettings;
    window.resetModerationStats = resetModerationStats;
  </script>

  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #06b6d4;
      --accent: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;

      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --bg-card: #1e293b;
      --bg-glass: rgba(30, 41, 59, 0.6);

      --sidebar-bg: #1a202c;
      --sidebar-hover: #2d3748;

      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;

      --border: rgba(51, 65, 85, 0.8);
      --border-light: rgba(148, 163, 184, 0.2);

      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.4);
      --shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.5);

      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      line-height: 1.6;
    }

    .app-container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      position: relative;
      z-index: 1000;
    }

    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
    }

    .logo-small {
      font-size: 1.2rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
    }

    .channels-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .channels-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .create-channel-btn {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: var(--primary);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }

    .create-channel-btn:hover {
      background: rgba(59, 130, 246, 0.2);
      transform: scale(1.1);
    }

    .channels-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .channels-list::-webkit-scrollbar {
      width: 4px;
    }

    .channels-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .channels-list::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.3);
      border-radius: 10px;
    }

    .sidebar-channel-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 0.25rem;
      position: relative;
      overflow: hidden;
    }

    .sidebar-channel-item:hover {
      background: var(--sidebar-hover);
    }

    .sidebar-channel-item.pinned-channel {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      margin-bottom: 0.75rem;
    }

    .sidebar-channel-item.pinned-channel:hover {
      background: rgba(16, 185, 129, 0.15);
    }

    .channels-separator {
      padding: 0.75rem 1rem 0.5rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0.5rem;
      margin-top: 0.25rem;
    }

    .channels-separator span {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .channel-icon-small {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .channel-info {
      flex: 1;
      min-width: 0;
    }

    .channel-name-small {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .channel-activity {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .channel-activity i {
      font-size: 0.6rem;
      color: var(--success);
    }

    .no-channels {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      padding: 2rem 1rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .no-channels i {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .no-channels.error {
      color: var(--error);
    }

    /* User Profile Section */
    .user-profile-section {
      margin-top: auto;
      border-top: 1px solid var(--border);
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      padding: 1rem;
    }

    .user-profile-card {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      flex-shrink: 0;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(59, 130, 246, 0.3);
    }

    .user-avatar:hover {
      transform: scale(1.1);
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .user-avatar:hover::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-avatar:hover::before {
      content: '📷';
      position: absolute;
      z-index: 1;
      font-size: 0.8rem;
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .user-role {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: capitalize;
    }

    .user-actions {
      display: flex;
      gap: 0.5rem;
    }

    .user-action-btn {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: var(--primary);
      border-radius: var(--radius-sm);
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
      flex: 1;
      text-align: center;
    }

    .user-action-btn:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .user-action-btn.staff {
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.3);
      color: var(--success);
    }

    .user-action-btn.staff:hover {
      background: rgba(16, 185, 129, 0.2);
    }

    .user-action-btn.logout {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: var(--error);
    }

    .user-action-btn.logout:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    .user-action-btn.settings {
      background: rgba(139, 92, 246, 0.1);
      border-color: rgba(139, 92, 246, 0.3);
      color: var(--accent);
    }

    .user-action-btn.settings:hover {
      background: rgba(139, 92, 246, 0.2);
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      position: relative;
    }

    .view {
      opacity: 0;
      transform: translateY(30px);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      display: none;
      height: 100%;
    }

    .view.active {
      opacity: 1;
      transform: translateY(0);
      display: flex;
      flex-direction: column;
    }

    /* Authentication View */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 2rem;
    }

    .auth-card {
      max-width: 450px;
      width: 100%;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 2rem;
      box-shadow: var(--shadow-xl);
    }

    .auth-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .auth-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }

    .auth-subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .auth-form {
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-input {
      width: 100%;
      padding: 1rem 1.25rem;
      border: 2px solid var(--border);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      transition: all 0.3s ease;
      background: rgba(30, 41, 59, 0.6);
      color: var(--text-primary);
      backdrop-filter: blur(10px);
      font-family: inherit;
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(30, 41, 59, 0.8);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
      transform: translateY(-2px);
    }

    .form-error {
      color: var(--error);
      font-size: 0.85rem;
      margin-top: 1rem;
      display: none;
      align-items: center;
      gap: 0.5rem;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: var(--radius-sm);
      padding: 0.75rem;
    }

    .primary-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: var(--radius-lg);
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .primary-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.6s ease;
    }

    .primary-btn:hover:not(:disabled)::before {
      left: 100%;
    }

    .primary-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    .primary-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .primary-btn.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .primary-btn.loading {
      color: transparent;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .auth-switch {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .auth-switch-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    .auth-switch-link:hover {
      text-decoration: underline;
    }

    .staff-switch {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .staff-link {
      color: var(--warning) !important;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .staff-link:hover {
      color: var(--success) !important;
    }

    .staff-login-notice {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: var(--radius-md);
      padding: 1rem;
      margin-bottom: 1.5rem;
      text-align: center;
      color: var(--warning);
    }

    .staff-login-notice i {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      display: block;
    }

    .staff-login-notice p {
      margin: 0;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .staff-btn-style {
      background: linear-gradient(135deg, var(--warning), #d97706);
    }

    .staff-btn-style:hover:not(:disabled) {
      background: linear-gradient(135deg, #d97706, var(--warning));
    }

    .staff-credentials-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: var(--radius-md);
      padding: 1rem;
      margin-top: 1rem;
      font-size: 0.85rem;
      color: var(--primary);
      line-height: 1.4;
    }

    .staff-credentials-info i {
      margin-right: 0.5rem;
    }

    .staff-credentials-info code {
      background: rgba(59, 130, 246, 0.2);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: var(--text-primary);
    }

    /* Welcome View */
    .welcome-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      text-align: center;
      padding: 2rem;
    }

    .welcome-logo {
      font-size: 4rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
      letter-spacing: -0.02em;
    }

    .welcome-subtitle {
      font-size: 1.2rem;
      color: var(--text-secondary);
      margin-bottom: 2rem;
      max-width: 600px;
    }

    .welcome-cta {
      color: var(--text-muted);
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Staff Dashboard */
    .staff-dashboard {
      padding: 2rem;
      overflow-y: auto;
      height: 100%;
    }

    .staff-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .staff-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .staff-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      display: block;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    .staff-section {
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .staff-section-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .staff-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .staff-item {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .staff-item:hover {
      background: rgba(30, 41, 59, 0.8);
      border-color: var(--primary);
    }

    .staff-item-info {
      flex: 1;
    }

    .staff-item-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }

    .staff-item-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .staff-item-role {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-admin {
      background: rgba(59, 130, 246, 0.2);
      color: var(--primary);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .role-mod {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .role-user {
      background: rgba(59, 130, 246, 0.2);
      color: var(--primary);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .staff-item-status {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-active {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-inactive {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .status-permanent {
      background: rgba(139, 92, 246, 0.2);
      color: var(--accent);
      border: 1px solid rgba(139, 92, 246, 0.3);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .staff-item-details {
      color: var(--text-muted);
      font-size: 0.85rem;
      display: flex;
      gap: 1rem;
    }

    .staff-item-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .staff-btn {
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .staff-btn.ban {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .staff-btn.unban {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .staff-btn.promote {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .staff-btn.delete {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .staff-btn.view {
      background: rgba(59, 130, 246, 0.2);
      color: var(--primary);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .staff-btn.demote {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .staff-btn.security {
      background: rgba(139, 92, 246, 0.2);
      color: var(--accent);
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .staff-btn.security-enabled {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .staff-btn.ghost {
      background: rgba(139, 92, 246, 0.2);
      color: var(--accent);
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .staff-btn.ghost-enabled {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .staff-btn:hover {
      transform: translateY(-1px);
      opacity: 0.8;
    }

    .staff-item-type {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .type-public {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .type-private {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .loading {
      color: var(--text-muted);
      text-align: center;
      padding: 2rem;
    }

    .no-data {
      color: var(--text-muted);
      text-align: center;
      padding: 2rem;
      font-style: italic;
    }

    .error {
      color: var(--error);
      text-align: center;
      padding: 2rem;
    }

    /* Form Views */
    .form-view {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 2rem;
    }

    .form-container {
      max-width: 500px;
      width: 100%;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 2rem;
      box-shadow: var(--shadow-xl);
    }

    .view-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .back-btn {
      width: 48px;
      height: 48px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--primary);
    }

    .back-btn:hover {
      background: rgba(59, 130, 246, 0.2);
      transform: translateX(-4px);
    }

    .view-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Chat View */
    .chat-container {
      display: flex;
      height: 100vh;
      position: relative;
    }

    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-right: 300px;
    }

    .chat-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }

    .chat-header-info {
      flex: 1;
      min-width: 0;
    }

    .chat-header-info h3 {
      color: var(--text-primary);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.1rem;
    }

    .chat-header-info p {
      color: var(--text-secondary);
      margin: 0;
      font-size: 0.85rem;
    }

    .chat-window {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: var(--bg-primary);
      scroll-behavior: smooth;
    }

    .chat-window::-webkit-scrollbar {
      width: 6px;
    }

    .chat-window::-webkit-scrollbar-track {
      background: rgba(51, 65, 85, 0.3);
      border-radius: 10px;
    }

    .chat-window::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--primary), var(--secondary));
      border-radius: 10px;
    }

    .message {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      animation: messageSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* System Messages for Join/Leave Notifications */
    .system-message {
      margin: 0.75rem 0;
      padding: 0.75rem;
      border-radius: var(--radius-sm);
      background: rgba(51, 65, 85, 0.3);
      border-left: 3px solid var(--text-muted);
      font-size: 0.85rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .system-message.join-message {
      background: rgba(16, 185, 129, 0.1);
      border-left-color: var(--success);
      color: var(--success);
    }

    .system-message.leave-message {
      background: rgba(100, 116, 139, 0.1);
      border-left-color: var(--text-muted);
      color: var(--text-muted);
    }

    .system-message-content {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-align: center;
    }

    .system-message-text {
      font-weight: 500;
    }

    .system-message-time {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-left: 0.5rem;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(15px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .message.own {
      flex-direction: row-reverse;
    }

    .message-avatar {
      flex-shrink: 0;
    }

    .avatar-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .message-content {
      max-width: 70%;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }

    .message.own .message-header {
      flex-direction: row-reverse;
    }

    .message-user {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.95rem;
    }

    .message-time {
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
    }

    .message-text {
      background: var(--bg-secondary);
      padding: 1rem 1.25rem;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      word-wrap: break-word;
      line-height: 1.5;
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
    }

    .message.own .message-text {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-color: transparent;
    }

    /* Message Input */
    .message-input-area {
      padding: 1rem 1.5rem;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      flex-shrink: 0;
    }

    .message-input {
      flex: 1;
      padding: 1rem 1.25rem;
      border: 2px solid var(--border);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      resize: none;
      min-height: 56px;
      max-height: 120px;
      background: rgba(30, 41, 59, 0.6);
      transition: all 0.3s ease;
      font-family: inherit;
      line-height: 1.5;
      color: var(--text-primary);
      backdrop-filter: blur(10px);
    }

    .message-input::placeholder {
      color: var(--text-muted);
    }

    .message-input:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(30, 41, 59, 0.8);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
    }

    .send-btn {
      background: linear-gradient(135deg, var(--success), #0d9488);
      color: white;
      border: none;
      width: 56px;
      height: 56px;
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
      box-shadow: var(--shadow-md);
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .send-btn.sending {
      animation: pulse 1.5s infinite;
    }

    .image-upload-btn {
      background: linear-gradient(135deg, #8b5cf6, #6d28d9);
      color: white;
      border: none;
      width: 56px;
      height: 56px;
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
      box-shadow: var(--shadow-md);
      margin-right: 0.5rem;
    }

    .image-upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, #7c3aed, #5b21b6);
    }

    .image-upload-btn:active {
      transform: translateY(0);
    }

    /* Image message styling */
    .image-message {
      margin-top: 0.5rem;
    }

    .chat-image {
      max-width: 300px;
      max-height: 200px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
      object-fit: cover;
    }

    .chat-image:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow-md);
    }

    .image-caption {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
      font-style: italic;
    }

    /* Image modal styling */
    .image-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      justify-content: center;
      align-items: center;
    }

    .image-modal.show {
      display: flex;
    }

    .image-modal-content {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
    }

    .image-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 2rem;
      color: white;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .image-modal-close:hover {
      background: rgba(0, 0, 0, 0.7);
      transform: scale(1.1);
    }

    .members-btn {
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.4);
      color: var(--primary);
      border-radius: var(--radius-lg);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      box-shadow: var(--shadow-sm);
    }

    .members-list-container {
      max-height: 400px;
      overflow-y: auto;
      padding: 1rem 0;
    }

    /* Discord-style Members List */
    .discord-members-list {
      max-height: 500px;
      overflow-y: auto;
      padding: 1rem 0;
    }

    .discord-members-list::-webkit-scrollbar {
      width: 6px;
    }

    .discord-members-list::-webkit-scrollbar-track {
      background: rgba(51, 65, 85, 0.3);
      border-radius: 10px;
    }

    .discord-members-list::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--primary), var(--secondary));
      border-radius: 10px;
    }

    .discord-member-card {
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-bottom: 0.75rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      width: 100%;
      box-sizing: border-box;
    }

    .discord-member-card:hover {
      background: rgba(30, 41, 59, 0.6);
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .discord-member-card.bot-member {
      border-left: 4px solid var(--accent);
      background: rgba(139, 92, 246, 0.05);
    }

    .discord-member-card.bot-member:hover {
      background: rgba(139, 92, 246, 0.1);
    }

    .discord-member-card.moderatable {
      position: relative;
    }

    .discord-member-card.timed-out {
      border-left: 4px solid var(--warning);
      background: rgba(245, 158, 11, 0.05);
    }

    .member-main-info {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .member-text-info {
      flex: 1;
      min-width: 0;
    }

    .member-badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.25rem;
    }

    .discord-member-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
      margin-bottom: 0.25rem;
      position: relative;
    }

    .discord-member-item:hover {
      background: rgba(59, 130, 246, 0.08);
    }

    .discord-member-item.bot-member {
      border-left: 3px solid var(--accent);
      background: rgba(139, 92, 246, 0.05);
    }

    .member-avatar-container {
      position: relative;
      flex-shrink: 0;
    }

    .member-avatar-img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid rgba(59, 130, 246, 0.3);
    }

    .member-avatar-letter {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      border: 2px solid rgba(59, 130, 246, 0.3);
    }

    .bot-avatar {
      background: linear-gradient(135deg, var(--accent), #7c3aed) !important;
      font-size: 1rem;
      border-color: rgba(139, 92, 246, 0.5) !important;
    }

    .member-status-indicator {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid var(--bg-primary);
    }

    .member-status-indicator.online {
      background: var(--success);
    }

    .member-status-indicator.offline {
      background: var(--text-muted);
    }

    .member-details {
      flex: 1;
      min-width: 0;
    }

    .member-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.15rem;
    }

    .member-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .member-badge {
      padding: 0.15rem 0.5rem;
      border-radius: 6px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .creator-badge {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 165, 0, 0.3));
      color: #FFD700;
      border: 1px solid rgba(255, 215, 0, 0.6);
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
      font-weight: 800;
      animation: creatorGlow 2s ease-in-out infinite alternate;
    }

    @keyframes creatorGlow {
      from {
        box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
      }
      to {
        box-shadow: 0 0 12px rgba(255, 215, 0, 0.5), 0 0 16px rgba(255, 215, 0, 0.2);
      }
    }

    /* Creator indicator in chat header */
    .creator-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.75rem;
      font-weight: 700;
      color: #FFD700;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.2));
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      border: 1px solid rgba(255, 215, 0, 0.4);
      margin-left: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      animation: creatorGlow 2s ease-in-out infinite alternate;
    }

    .creator-indicator i {
      font-size: 0.8rem;
    }

    .staff-badge {
      background: rgba(59, 130, 246, 0.2);
      color: var(--primary);
      border: 1px solid rgba(59, 130, 246, 0.4);
    }

    .bot-badge {
      background: rgba(139, 92, 246, 0.2);
      color: var(--accent);
      border: 1px solid rgba(139, 92, 246, 0.4);
    }

    .role-mod-badge {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .role-vip-badge {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(218, 165, 32, 0.2));
      color: #FFD700;
      border: 1px solid rgba(255, 215, 0, 0.4);
    }

    .role-regular-badge {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.4);
    }

    .role-custom-badge {
      background: rgba(139, 92, 246, 0.2);
      color: var(--accent);
      border: 1px solid rgba(139, 92, 246, 0.4);
    }

    /* Quick Action Buttons */
    .member-quick-actions {
      display: flex;
      gap: 0.25rem;
      justify-content: flex-end;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .discord-action-btn {
      background: rgba(59, 130, 246, 0.08);
      border: 1px solid rgba(59, 130, 246, 0.25);
      color: var(--primary);
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.65rem;
      font-weight: 600;
      min-width: 50px;
      justify-content: center;
      text-transform: uppercase;
      letter-spacing: 0.2px;
    }

    .discord-action-btn:hover {
      background: rgba(59, 130, 246, 0.15);
      transform: scale(1.05);
      box-shadow: 0 1px 4px rgba(59, 130, 246, 0.2);
    }

    .discord-action-btn i {
      font-size: 0.6rem;
    }

    .discord-action-btn.add-role-btn {
      background: rgba(16, 185, 129, 0.08);
      border: 1px solid rgba(16, 185, 129, 0.25);
      color: var(--success);
    }

    .discord-action-btn.add-role-btn:hover {
      background: rgba(16, 185, 129, 0.15);
      box-shadow: 0 1px 4px rgba(16, 185, 129, 0.2);
    }

    .discord-action-btn.remove-role-btn {
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.25);
      color: var(--error);
    }

    .discord-action-btn.remove-role-btn:hover {
      background: rgba(239, 68, 68, 0.15);
      box-shadow: 0 1px 4px rgba(239, 68, 68, 0.2);
    }

    .discord-action-btn.timeout-btn {
      background: rgba(245, 158, 11, 0.08);
      border: 1px solid rgba(245, 158, 11, 0.25);
      color: var(--warning);
    }

    .discord-action-btn.timeout-btn:hover {
      background: rgba(245, 158, 11, 0.15);
      box-shadow: 0 1px 4px rgba(245, 158, 11, 0.2);
    }

    .discord-action-btn.remove-timeout-btn {
      background: rgba(16, 185, 129, 0.08);
      border: 1px solid rgba(16, 185, 129, 0.25);
      color: var(--success);
    }

    .discord-action-btn.remove-timeout-btn:hover {
      background: rgba(16, 185, 129, 0.15);
      box-shadow: 0 1px 4px rgba(16, 185, 129, 0.2);
    }

    .member-status-text {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .members-modal .modal-content {
      max-width: 550px;
    }

    /* Legacy member item styles for compatibility */
    .member-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      border-radius: var(--radius-md);
      transition: all 0.3s ease;
      margin-bottom: 0.5rem;
    }

    .member-item:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    .member-avatar {
      flex-shrink: 0;
    }

    .avatar-circle-small {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .member-info {
      flex: 1;
      min-width: 0;
    }

    .member-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(12px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      transition: all 0.4s ease;
      padding: 2rem;
    }

    .modal.show {
      opacity: 1;
    }

    .modal-content {
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      box-shadow: var(--shadow-xl);
      transform: scale(0.9);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal.show .modal-content {
      transform: scale(1);
    }

    .modal-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }

    .modal-subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .secondary-btn {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 1rem 1.5rem;
      border-radius: var(--radius-lg);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      font-size: 0.95rem;
      backdrop-filter: blur(10px);
    }

    .secondary-btn:hover {
      background: rgba(30, 41, 59, 1);
      border-color: var(--primary);
      color: var(--primary);
    }

    .channel-type-note {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      padding: 0.75rem;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      color: var(--primary);
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 2rem;
      right: 2rem;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      color: white;
      font-weight: 500;
      z-index: 10000;
      transform: translateX(100%);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      min-width: 350px;
      max-width: 420px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: linear-gradient(135deg, var(--success), #059669);
      border-color: rgba(16, 185, 129, 0.6);
      box-shadow: 0 8px 32px rgba(16, 185, 129, 0.2);
    }

    .notification.error {
      background: linear-gradient(135deg, var(--error), #dc2626);
      border-color: rgba(239, 68, 68, 0.6);
      box-shadow: 0 8px 32px rgba(239, 68, 68, 0.2);
    }

    .notification.info {
      background: linear-gradient(135deg, #1e40af, #2563eb, #3b82f6);
      border-color: rgba(59, 130, 246, 0.6);
      box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
    }

    .notification-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
    }

    .notification-close {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      transition: all 0.3s ease;
    }

    .notification-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    @keyframes slideIn {
      0% {
        transform: translateX(100%);
        opacity: 0;
        scale: 0.95;
      }
      100% {
        transform: translateX(0);
        opacity: 1;
        scale: 1;
      }
    }

    @keyframes slideOut {
      0% {
        transform: translateX(0);
        opacity: 1;
        scale: 1;
      }
      100% {
        transform: translateX(100%);
        opacity: 0;
        scale: 0.95;
      }
    }

    /* Animation for pulse effect */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Bot Message Styling */
    .message.bot-message {
      border-left: 3px solid var(--accent);
      background: rgba(139, 92, 246, 0.05);
      border-radius: var(--radius-md);
      padding-left: 0.5rem;
      margin-left: 0.5rem;
    }

    .bot-avatar {
      background: linear-gradient(135deg, var(--accent), #7c3aed) !important;
      border: 2px solid rgba(139, 92, 246, 0.5);
    }

    .bot-text {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
    }

    .bot-text code {
      background: rgba(139, 92, 246, 0.2);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
    }

    .bot-badge {
      background: rgba(139, 92, 246, 0.2);
      color: var(--accent);
      border: 1px solid rgba(139, 92, 246, 0.4);
      padding: 0.1rem 0.4rem;
      border-radius: 3px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 0.5rem;
    }

    /* Command Suggestions */
    .command-suggestions {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: rgba(59, 130, 246, 0.15);
      backdrop-filter: blur(25px);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: var(--shadow-xl);
    }

    .command-suggestion {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .command-suggestion:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .command-suggestion:last-child {
      border-bottom: none;
    }

    .command-name {
      font-weight: 600;
      color: var(--primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .command-desc {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }

    .command-usage {
      color: var(--text-muted);
      font-size: 0.75rem;
      font-family: 'JetBrains Mono', monospace;
      opacity: 0.8;
    }

    /* Message Input Area Updates */
    .message-input-area {
      position: relative;
    }

    /* Ghost Mode Indicator */
    .ghost-mode-indicator {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(139, 92, 246, 0.2);
      color: var(--accent);
      border: 1px solid rgba(139, 92, 246, 0.4);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 100;
    }

    .ghost-mode-indicator i {
      animation: pulse 2s infinite;
    }

    /* Security Bot Status */
    .security-bot-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: var(--radius-sm);
      color: var(--success);
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
    }

    .security-bot-status.disabled {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: var(--error);
    }

    /* Role Modal */
    .role-modal .modal-content {
      max-width: 450px;
    }

    .role-options {
      margin-bottom: 1.5rem;
    }

    .role-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .role-option-btn {
      background: rgba(30, 41, 59, 0.6);
      border: 2px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1rem 1.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 1rem;
      width: 100%;
      text-align: left;
    }

    .role-option-btn:hover {
      background: rgba(30, 41, 59, 0.8);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .role-option-btn.moderator-role {
      border-color: rgba(245, 158, 11, 0.4);
    }

    .role-option-btn.moderator-role:hover {
      border-color: var(--warning);
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
    }

    .role-option-btn.vip-role {
      border-color: rgba(255, 215, 0, 0.4);
    }

    .role-option-btn.vip-role:hover {
      border-color: #FFD700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
    }

    .role-option-btn.regular-role {
      border-color: rgba(16, 185, 129, 0.4);
    }

    .role-option-btn.regular-role:hover {
      border-color: var(--success);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
    }

    .role-option-btn i {
      font-size: 1.5rem;
      color: var(--primary);
      width: 32px;
      display: flex;
      justify-content: center;
    }

    .role-option-btn.moderator-role i {
      color: var(--warning);
    }

    .role-option-btn.vip-role i {
      color: #FFD700;
    }

    .role-option-btn.regular-role i {
      color: var(--success);
    }

    .role-info {
      flex: 1;
    }

    .role-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1rem;
      display: block;
      margin-bottom: 0.25rem;
    }

    .role-desc {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    /* Timeout Modal */
    .timeout-modal .modal-content {
      max-width: 450px;
    }

    .timeout-options {
      margin-bottom: 1.5rem;
    }

    .timeout-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .timeout-quick-btn {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: var(--primary);
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .timeout-quick-btn:hover {
      background: rgba(59, 130, 246, 0.2);
      transform: translateY(-2px);
    }

    .timeout-quick-btn i {
      font-size: 1.1rem;
    }

    /* Member Actions */
    .discord-member-item.moderatable {
      transition: all 0.3s ease;
    }

    .discord-member-item.moderatable:hover {
      background: rgba(59, 130, 246, 0.08);
      border-radius: var(--radius-sm);
      padding: 0.5rem 1rem;
      margin: 0 -1rem 0.25rem -1rem;
    }

    /* Timeout Status Styling */
    .discord-member-card.timed-out {
      border-left: 4px solid var(--warning);
      background: rgba(245, 158, 11, 0.05);
      opacity: 0.8;
    }

    .timeout-badge {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .timeout-overlay {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 16px;
      height: 16px;
      background: var(--warning);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.6rem;
      border: 2px solid var(--bg-primary);
      animation: pulse 2s infinite;
    }

    .timeout-status {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: var(--radius-sm);
      color: var(--warning);
      font-size: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .timeout-time {
      font-weight: 600;
      color: var(--warning);
    }

    .timeout-reason {
      color: var(--text-muted);
      font-style: italic;
    }

    .remove-timeout-btn {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--success);
    }

    .remove-timeout-btn:hover {
      background: rgba(16, 185, 129, 0.2);
    }

    /* Message Badges Container */
    .message-badges {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .message-header {
      align-items: flex-start;
      position: relative;
    }

    /* Message Delete Button */
    .message-delete-btn {
      position: absolute;
      right: 0;
      top: 0;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--error);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.7rem;
      opacity: 0;
      transform: scale(0.8);
    }

    .message:hover .message-delete-btn {
      display: flex;
      opacity: 1;
      transform: scale(1);
    }

    .message-delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: var(--error);
      transform: scale(1.1);
    }

    .message-delete-btn:active {
      transform: scale(0.95);
    }

    /* Adjust message header spacing for delete button */
    .message-header {
      padding-right: 32px;
    }

    .member-actions {
      display: none;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .discord-member-item.moderatable:hover .member-actions {
      display: flex;
    }

    .member-action-btn {
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .member-action-btn:hover {
      transform: translateY(-1px);
    }

    .timeout-btn {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .timeout-btn:hover {
      background: rgba(245, 158, 11, 0.3);
    }

    .kick-btn {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .kick-btn:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    .ban-btn {
      background: rgba(127, 29, 29, 0.3);
      color: #dc2626;
      border: 1px solid rgba(127, 29, 29, 0.5);
    }

    .ban-btn:hover {
      background: rgba(127, 29, 29, 0.4);
    }

    /* Settings Modal */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--bg-primary);
      display: none;
      z-index: 4000;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .settings-modal.show {
      opacity: 1;
    }

    .settings-modal-content {
      width: 100%;
      height: 100%;
      display: flex;
      overflow: hidden;
      background: var(--bg-primary);
    }

    .settings-sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      padding: 1.5rem;
      overflow-y: auto;
      height: 100vh;
    }

    .settings-main {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      height: 100vh;
      background: var(--bg-primary);
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
      padding: 1.5rem 0 1rem 0;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--bg-primary);
      z-index: 100;
    }

    .settings-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .settings-close {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--error);
      border-radius: var(--radius-lg);
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.1rem;
    }

    .settings-close:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: scale(1.05);
    }

    .settings-nav {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .settings-nav-item {
      margin-bottom: 0.5rem;
    }

    .settings-nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
    }

    .settings-nav-link:hover,
    .settings-nav-link.active {
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
    }

    .settings-section {
      display: none;
    }

    .settings-section.active {
      display: block;
    }

    .settings-section-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .settings-group {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .settings-group-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .settings-group-desc {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }

    .settings-field {
      margin-bottom: 1.5rem;
    }

    .settings-field:last-child {
      margin-bottom: 0;
    }

    .settings-label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .settings-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: rgba(30, 41, 59, 0.6);
      color: var(--text-primary);
      backdrop-filter: blur(10px);
      font-family: inherit;
    }

    .settings-input:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(30, 41, 59, 0.8);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
    }

    .settings-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .settings-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .settings-btn.secondary {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid var(--border);
      color: var(--text-primary);
    }

    .settings-btn.secondary:hover {
      background: rgba(30, 41, 59, 1);
      border-color: var(--primary);
      color: var(--primary);
    }

    .theme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: 1rem;
      padding: 1rem;
      max-width: 500px;
    }

    .theme-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s ease;
      position: relative;
    }

    .theme-circle:hover {
      transform: scale(1.1);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .theme-circle.selected {
      border-color: var(--primary);
      transform: scale(1.15);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }

    /* Theme Colors */
    .theme-default { background: linear-gradient(135deg, #1e293b, #0f172a); }
    .theme-mint { background: linear-gradient(135deg, #6ee7b7, #10b981); }
    .theme-sunset { background: linear-gradient(135deg, #fb923c, #ea580c); }
    .theme-ocean { background: linear-gradient(135deg, #7dd3fc, #0ea5e9); }
    .theme-forest { background: linear-gradient(135deg, #4ade80, #16a34a); }
    .theme-rose { background: linear-gradient(135deg, #fb7185, #e11d48); }
    .theme-lavender { background: linear-gradient(135deg, #c084fc, #9333ea); }
    .theme-arctic { background: linear-gradient(135deg, #e0f2fe, #0891b2); }
    .theme-warm { background: linear-gradient(135deg, #fde68a, #d97706); }
    .theme-cosmic { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
    .theme-emerald { background: linear-gradient(135deg, #34d399, #059669); }
    .theme-volcano { background: linear-gradient(135deg, #dc2626, #7f1d1d); }
    .theme-deep { background: linear-gradient(135deg, #1e40af, #1e1b4b); }
    .theme-autumn { background: linear-gradient(135deg, #a3a3a3, #404040); }
    .theme-neon { background: linear-gradient(135deg, #06b6d4, #0e7490); }

    .device-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      margin-bottom: 1rem;
      background: rgba(30, 41, 59, 0.4);
    }

    .device-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .device-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.1rem;
    }

    .device-details h4 {
      margin: 0;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .device-details p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .device-current {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--success);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        position: absolute;
        left: -100%;
        transition: left 0.3s ease;
        z-index: 2000;
      }

      .sidebar.mobile-open {
        left: 0;
      }

      .app-container {
        position: relative;
      }

      .main-content {
        width: 100%;
      }

      .form-container, .auth-card {
        margin: 1rem;
        padding: 1.5rem;
      }

      .welcome-logo {
        font-size: 2.5rem;
      }

      .message {
        gap: 0.5rem;
      }

      .message-content {
        max-width: 85%;
      }

      .staff-stats {
        grid-template-columns: 1fr;
      }

      .staff-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .staff-item-actions {
        width: 100%;
        justify-content: flex-end;
      }

      /* Settings mobile adjustments */
      .settings-modal-content {
        flex-direction: column;
      }

      .settings-sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
        padding: 1rem;
      }

      .settings-nav {
        display: flex;
        overflow-x: auto;
        gap: 0.5rem;
        padding-bottom: 0.5rem;
      }

      .settings-nav-item {
        margin-bottom: 0;
        flex-shrink: 0;
      }

      .settings-nav-link {
        white-space: nowrap;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }

      .settings-main {
        height: auto;
        flex: 1;
        padding: 1rem;
      }

      .settings-title {
        font-size: 1.5rem;
      }
    }

    /* Timeout Indicator */
    .timeout-indicator {
      position: absolute;
      top: -40px;
      left: 0;
      right: 0;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      color: var(--error);
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 100;
      animation: slideInTimeout 0.3s ease;
    }

    @keyframes slideInTimeout {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Fix modal backdrop blur */
    .modal {
      backdrop-filter: blur(8px);
    }

    .modal.show .modal-content {
      transform: scale(1);
      backdrop-filter: none;
    }

    /* Improved modal transitions */
    .role-modal .modal-content,
    .timeout-modal .modal-content {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Disabled input styling for timeout */
    .message-input:disabled {
      background: rgba(239, 68, 68, 0.1) !important;
      border-color: var(--error) !important;
      color: var(--error) !important;
      cursor: not-allowed;
    }

    .message-input:disabled::placeholder {
      color: var(--error);
      opacity: 0.8;
    }

    /* Members Sidebar */
    .members-sidebar {
      position: absolute;
      top: 0;
      right: 0;
      width: 300px;
      height: 100%;
      background: var(--sidebar-bg);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 100;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
    }

    .members-sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .members-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .members-count {
      background: rgba(59, 130, 246, 0.2);
      color: var(--primary);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 0.15rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 700;
      min-width: 24px;
      text-align: center;
    }

    .close-members-btn {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--error);
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }

    .close-members-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: scale(1.1);
    }

    .members-sidebar-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .members-sidebar-list::-webkit-scrollbar {
      width: 4px;
    }

    .members-sidebar-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .members-sidebar-list::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.3);
      border-radius: 10px;
    }

    .member-category {
      margin-bottom: 1rem;
    }

    .member-category-header {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .member-category-count {
      background: rgba(100, 116, 139, 0.2);
      color: var(--text-muted);
      border-radius: 8px;
      padding: 0.1rem 0.4rem;
      font-size: 0.7rem;
      font-weight: 700;
    }

    .member-sidebar-item {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 0.25rem;
      position: relative;
      width: 100%;
      box-sizing: border-box;
    }

    .member-sidebar-main {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
    }

    .member-sidebar-item:hover {
      background: var(--sidebar-hover);
    }

    .member-sidebar-item.staff-member {
      background: rgba(59, 130, 246, 0.05);
      border-left: 3px solid var(--primary);
    }

    .member-sidebar-item.staff-member:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    .member-sidebar-item.bot-member {
      background: rgba(139, 92, 246, 0.05);
      border-left: 3px solid var(--accent);
    }

    .member-sidebar-item.bot-member:hover {
      background: rgba(139, 92, 246, 0.1);
    }

    .member-sidebar-item.timed-out {
      opacity: 0.6;
      background: rgba(245, 158, 11, 0.05);
      border-left: 3px solid var(--warning);
    }

    .member-sidebar-avatar {
      position: relative;
      flex-shrink: 0;
    }

    .member-sidebar-avatar-img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid rgba(59, 130, 246, 0.3);
    }

    .member-sidebar-avatar-letter {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.8rem;
      border: 2px solid rgba(59, 130, 246, 0.3);
    }

    .member-sidebar-avatar.bot .member-sidebar-avatar-letter {
      background: linear-gradient(135deg, var(--accent), #7c3aed) !important;
      border-color: rgba(139, 92, 246, 0.5) !important;
      font-size: 0.9rem;
    }

    .member-sidebar-status {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid var(--sidebar-bg);
    }

    .member-sidebar-status.online {
      background: var(--success);
    }

    .member-sidebar-status.offline {
      background: var(--text-muted);
    }

    .member-sidebar-status.away {
      background: var(--warning);
    }

    .member-sidebar-status.dnd {
      background: var(--error);
    }

    .member-sidebar-info {
      flex: 1;
      min-width: 0;
    }

    .member-sidebar-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .member-sidebar-activity {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 0.1rem;
    }

    .member-sidebar-badges {
      display: flex;
      gap: 0.25rem;
      margin-top: 0.25rem;
    }

    .member-sidebar-badge {
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      font-size: 0.6rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .member-sidebar-badge.staff {
      background: rgba(59, 130, 246, 0.2);
      color: var(--primary);
      border: 1px solid rgba(59, 130, 246, 0.4);
    }

    .member-sidebar-badge.bot {
      background: rgba(139, 92, 246, 0.2);
      color: var(--accent);
      border: 1px solid rgba(139, 92, 246, 0.4);
    }

    .member-sidebar-badge.mod {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .member-sidebar-badge.vip {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(218, 165, 32, 0.2));
      color: #FFD700;
      border: 1px solid rgba(255, 215, 0, 0.4);
    }

    .member-sidebar-badge.timeout {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .member-timeout-indicator {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 14px;
      height: 14px;
      background: var(--warning);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.6rem;
      border: 1px solid var(--sidebar-bg);
      animation: pulse 2s infinite;
    }

    .member-moderation-actions {
      display: none;
      gap: 0.2rem;
      margin-top: 0.4rem;
      width: 100%;
      box-sizing: border-box;
    }

    .member-sidebar-item:hover .member-moderation-actions {
      display: flex;
    }

    .member-mod-btn {
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: var(--primary);
      border-radius: 4px;
      padding: 0.15rem 0.35rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.55rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.2rem;
      flex: 1;
      justify-content: center;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      min-height: 20px;
      max-width: 60px;
    }

    .member-mod-btn:hover {
      background: rgba(59, 130, 246, 0.25);
      transform: translateY(-1px);
    }

    .member-mod-btn.timeout {
      background: rgba(245, 158, 11, 0.15);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: var(--warning);
    }

    .member-mod-btn.timeout:hover {
      background: rgba(245, 158, 11, 0.25);
      transform: translateY(-1px);
    }

    .member-mod-btn.remove-timeout {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--success);
    }

    .member-mod-btn.remove-timeout:hover {
      background: rgba(16, 185, 129, 0.25);
      transform: translateY(-1px);
    }

    .members-loading {
      padding: 2rem;
      text-align: center;
      color: var(--text-muted);
      font-style: italic;
    }

    .members-empty {
      padding: 2rem;
      text-align: center;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Admin Moderation Styles */
    .admin-only {
      display: none !important;
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }

    .input-group .settings-input {
      flex: 1;
    }

    .settings-select {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      padding: 0.5rem;
      font-size: 0.875rem;
      width: 100%;
    }

    .bad-words-list-container {
      margin-top: 1rem;
    }

    .bad-words-title {
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .bad-words-list {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 1rem;
      min-height: 120px;
      max-height: 200px;
      overflow-y: auto;
    }

    .bad-words-empty {
      text-align: center;
      color: var(--text-muted);
      font-style: italic;
      padding: 2rem;
    }

    .bad-word-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-light);
      border-radius: 4px;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.5rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.875rem;
    }

    .bad-word-text {
      color: var(--text-primary);
      font-weight: 500;
    }

    .bad-word-remove {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--error);
      border-radius: 4px;
      padding: 0.2rem 0.4rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.7rem;
    }

    .bad-word-remove:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: translateY(-1px);
    }

    .moderation-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .stat-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 1rem;
      text-align: center;
    }

    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Mobile responsive for members sidebar */
    @media (max-width: 768px) {
      .members-sidebar {
        width: 250px;
        right: 0;
      }

      .chat-main {
        margin-right: 250px;
      }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="logo-small">AlQUlOl CHAT</div>
      </div>

      <div class="channels-header">
        <div class="channels-title">
          <i class="fas fa-hashtag"></i>
          Channels
        </div>
        <button class="create-channel-btn" onclick="createChat()" title="Create Channel">
          <i class="fas fa-plus"></i>
        </button>
      </div>

      <div id="channelsList" class="channels-list">
        <!-- Channels will be populated here -->
      </div>

      <!-- User Profile Section -->
      <div class="user-profile-section">
        <div class="user-profile-card">
          <div class="user-avatar" onclick="handleProfilePictureUpload()" title="Click to change profile picture">
            <i class="fas fa-user"></i>
          </div>
          <div class="user-info">
            <div class="user-name">Guest User</div>
            <div class="user-role">user</div>
          </div>
        </div>
        <div class="user-actions">
          <button class="user-action-btn settings" onclick="openSettings()">
            <i class="fas fa-cog"></i>
            Settings
          </button>
          <button id="staffDashboardBtn" class="user-action-btn staff" onclick="openStaffDashboard()" style="display: none;">
            <i class="fas fa-shield-alt"></i>
            Staff
          </button>
          <button class="user-action-btn logout" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Authentication View -->
      <div id="loginView" class="view active">
        <div class="auth-container">
          <div class="auth-card">
            <div class="auth-header">
              <h3 id="authTitle" class="auth-title">
                <i class="fas fa-sign-in-alt"></i>
                Login to Your Account
              </h3>
              <p class="auth-subtitle">Welcome back! Please enter your credentials.</p>
            </div>

            <div id="authError" class="form-error"></div>

            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user"></i>
                  Username
                </label>
                <input id="loginUsername" class="form-input" placeholder="Enter your username">
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-lock"></i>
                  Password
                </label>
                <input id="loginPassword" type="password" class="form-input" placeholder="Enter your password">
              </div>

              <button id="loginBtn" class="primary-btn" onclick="login()">
                <span>Login</span>
              </button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="auth-form" style="display: none;">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user"></i>
                  Username
                </label>
                <input id="regUsername" class="form-input" placeholder="Choose a username">
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-envelope"></i>
                  Email
                </label>
                <input id="regEmail" type="email" class="form-input" placeholder="Enter your email">
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-lock"></i>
                  Password
                </label>
                <input id="regPassword" type="password" class="form-input" placeholder="Create a password">
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-lock"></i>
                  Confirm Password
                </label>
                <input id="regConfirmPassword" type="password" class="form-input" placeholder="Confirm your password">
              </div>

              <button id="registerBtn" class="primary-btn" onclick="register()">
                <span>Create Account</span>
              </button>
            </div>

            <!-- Staff Login Form -->
            <div id="staffLoginForm" class="auth-form" style="display: none;">
              <div class="staff-login-notice">
                <i class="fas fa-shield-alt"></i>
                <p>Secure staff access portal. Only authorized personnel with valid credentials can access administrative features.</p>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-user-shield"></i>
                  Staff Username
                </label>
                <input id="staffUsername" class="form-input" placeholder="Enter staff username">
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-key"></i>
                  Staff Password
                </label>
                <input id="staffPassword" type="password" class="form-input" placeholder="Enter staff password">
              </div>

              <button id="staffLoginBtn" class="primary-btn staff-btn-style" onclick="staffLogin()">
                <span>Access Staff Dashboard</span>
              </button>

              <div class="staff-credentials-info">
                <i class="fas fa-info-circle"></i>
                <strong>welcome:</strong><br>
           please dont ghool as staff
           
              </div>
            </div>



            <div class="auth-switch">
              <span id="authSwitchText">Don't have an account? </span>
              <a id="authSwitchLink" class="auth-switch-link" onclick="switchAuthMode()">Sign up</a>
            </div>

            <div id="staffSwitchText" class="staff-switch">
              <span>Staff member? </span>
              <a class="auth-switch-link staff-link" onclick="switchToStaffLogin()">
                <i class="fas fa-shield-alt"></i>
                Staff Login
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Welcome View -->
      <div id="welcomeView" class="view">
        <div class="welcome-container">
          <div class="welcome-logo">ALQUlOl CHAT</div>
          <div class="welcome-subtitle">
            Simple and secure chat application with user accounts and staff moderation.
          </div>
          <div class="welcome-cta">
            <i class="fas fa-arrow-left"></i>
            Select a channel from the sidebar to begin chatting
          </div>
        </div>
      </div>

      <!-- Channel Login View -->
      <div id="channelLoginView" class="view">
        <div class="form-view">
          <div class="form-container">
            <div class="view-header">
              <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
              </button>
              <div>
                <h2 class="view-title">Enter Password</h2>
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                  Joining: <strong id="loginChannelName"></strong>
                </p>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-key"></i>
                Password
              </label>
              <input id="passwordInput" type="password" class="form-input" placeholder="Enter channel password">
            </div>
            <button id="joinButton" class="primary-btn" onclick="joinChat()">
              <span>Join Channel</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Staff Dashboard View -->
      <div id="staffDashboardView" class="view">
        <div class="staff-dashboard">
          <div class="staff-header">
            <button class="back-btn" onclick="goBack()">
              <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="staff-title">
              <i class="fas fa-shield-alt"></i>
              Staff Dashboard
            </h1>
          </div>

          <div class="staff-stats">
            <div class="stat-card">
              <span id="totalUsers" class="stat-number">0</span>
              <span class="stat-label">Total Users</span>
            </div>
            <div class="stat-card">
              <span id="activeUsers" class="stat-number">0</span>
              <span class="stat-label">Active Users</span>
            </div>
            <div class="stat-card">
              <span id="totalChannels" class="stat-number">0</span>
              <span class="stat-label">Total Channels</span>
            </div>
            <div class="stat-card">
              <span id="bannedUsers" class="stat-number">0</span>
              <span class="stat-label">Banned Users</span>
            </div>
          </div>

          <div class="staff-section">
            <h2 class="staff-section-title">
              <i class="fas fa-users"></i>
              User Management
            </h2>
            <div id="usersList" class="staff-list">
              <!-- Users will be loaded here -->
            </div>
          </div>

          <div class="staff-section">
            <h2 class="staff-section-title">
              <i class="fas fa-hashtag"></i>
              Channel Management
            </h2>
            <div id="channelsManagementList" class="staff-list">
              <!-- Channels will be loaded here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Chat View -->
      <div id="chatView" class="view">
        <div class="chat-container">
          <div class="chat-main">
            <div class="chat-header">
              <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
              </button>
              <div class="chat-header-info">
                <h3>
                  <i class="fas fa-hashtag"></i>
                  <span id="chatChannelName"></span>
                  <span id="creatorIndicator" class="creator-indicator" style="display: none;">
                    <i class="fas fa-crown"></i>
                    Your Channel
                  </span>
                </h3>
                <p id="channelDescription">Secure chat channel</p>
              </div>
              <div class="members-btn">
                <i class="fas fa-users"></i>
                <span id="memberCount">0</span>
              </div>
            </div>

            <div id="chatWindow" class="chat-window"></div>

            <div class="message-input-area">
              <button id="imageUploadButton" class="image-upload-btn" onclick="handleImageUpload()" title="Upload image">
                <i class="fas fa-image"></i>
              </button>
              <textarea id="messageInput" class="message-input" placeholder="Type your message..." rows="1"></textarea>
              <button id="sendButton" class="send-btn" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>

          <!-- Members Sidebar -->
          <div id="membersSidebar" class="members-sidebar">
            <div class="members-sidebar-header">
              <div class="members-title">
                <i class="fas fa-users"></i>
                <span id="membersTitle">Members</span>
                <span id="membersCount" class="members-count">—</span>
              </div>
            </div>

            <div id="membersListSidebar" class="members-sidebar-list">
              <!-- Members will be populated here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Channel Modal -->
    <div id="createModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-plus"></i>
            Create Private Channel
          </h3>
          <p class="modal-subtitle">Create a new private chat channel</p>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-hashtag"></i>
            Channel Name
          </label>
          <input id="newChannelName" class="form-input" placeholder="Enter channel name">
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-lock"></i>
            Password
          </label>
          <input id="newChannelPassword" type="password" class="form-input" placeholder="Enter password (any length)">
          <div class="channel-type-note">
            <i class="fas fa-info-circle"></i>
            All user-created channels are private and require a password
          </div>
        </div>

        <div class="modal-actions">
          <button class="secondary-btn" onclick="closeModal()">Cancel</button>
          <button class="primary-btn" onclick="confirmCreateChat()">Create Channel</button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="settings-modal">
      <div class="settings-modal-content">
        <div class="settings-sidebar">
          <ul class="settings-nav">
            <li class="settings-nav-item">
              <a class="settings-nav-link active" data-section="account">
                <i class="fas fa-user"></i>
                My Account
              </a>
            </li>
            <li class="settings-nav-item">
              <a class="settings-nav-link" data-section="profile">
                <i class="fas fa-id-card"></i>
                Profile & Avatar
              </a>
            </li>
            <li class="settings-nav-item">
              <a class="settings-nav-link" data-section="appearance">
                <i class="fas fa-palette"></i>
                Appearance
              </a>
            </li>
            <li class="settings-nav-item">
              <a class="settings-nav-link" data-section="devices">
                <i class="fas fa-desktop"></i>
                Devices & Sessions
              </a>
            </li>
            <li class="settings-nav-item">
              <a class="settings-nav-link" data-section="privacy">
                <i class="fas fa-shield-alt"></i>
                Privacy & Safety
              </a>
            </li>
            <li class="settings-nav-item">
              <a class="settings-nav-link" data-section="notifications">
                <i class="fas fa-bell"></i>
                Notifications
              </a>
            </li>
            <li class="settings-nav-item admin-only" style="display: none;">
              <a class="settings-nav-link" data-section="moderation">
                <i class="fas fa-gavel"></i>
                Moderation
              </a>
            </li>
          </ul>
        </div>

        <div class="settings-main">
          <div class="settings-header">
            <h2 class="settings-title">
              <i class="fas fa-cog"></i>
              User Settings
            </h2>
            <button class="settings-close" onclick="closeSettings()">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <!-- Account Section -->
          <div id="account-section" class="settings-section active">
            <h3 class="settings-section-title">
              <i class="fas fa-user"></i>
              My Account
            </h3>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-id-card"></i>
                Account Information
              </h4>
              <p class="settings-group-desc">Update your basic account information and credentials.</p>

              <div class="settings-field">
                <label class="settings-label">Username</label>
                <input id="settingsUsername" class="settings-input" placeholder="Your username">
              </div>

              <div class="settings-field">
                <label class="settings-label">Email Address</label>
                <input id="settingsEmail" type="email" class="settings-input" placeholder="Your email">
              </div>

              <button class="settings-btn" onclick="updateAccountInfo()">
                <i class="fas fa-save"></i>
                Save Changes
              </button>
            </div>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-lock"></i>
                Password & Security
              </h4>
              <p class="settings-group-desc">Keep your account secure with a strong password.</p>

              <div class="settings-field">
                <label class="settings-label">Current Password</label>
                <input id="currentPassword" type="password" class="settings-input" placeholder="Enter current password">
              </div>

              <div class="settings-field">
                <label class="settings-label">New Password</label>
                <input id="newPassword" type="password" class="settings-input" placeholder="Enter new password">
              </div>

              <div class="settings-field">
                <label class="settings-label">Confirm New Password</label>
                <input id="confirmNewPassword" type="password" class="settings-input" placeholder="Confirm new password">
              </div>

              <button class="settings-btn" onclick="updatePassword()">
                <i class="fas fa-key"></i>
                Update Password
              </button>
            </div>
          </div>

          <!-- Profile Section -->
          <div id="profile-section" class="settings-section">
            <h3 class="settings-section-title">
              <i class="fas fa-id-card"></i>
              Profile & Avatar
            </h3>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-image"></i>
                Profile Picture
              </h4>
              <p class="settings-group-desc">Upload a custom profile picture or choose from presets.</p>

              <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem;">
                <div id="settingsAvatar" class="user-avatar" style="width: 80px; height: 80px; font-size: 1.5rem;">
                  <i class="fas fa-user"></i>
                </div>
                <div>
                  <button class="settings-btn" onclick="handleProfilePictureUpload()">
                    <i class="fas fa-upload"></i>
                    Upload New Picture
                  </button>
                  <button class="settings-btn secondary" onclick="removeProfilePicture()">
                    <i class="fas fa-trash"></i>
                    Remove Picture
                  </button>
                </div>
              </div>
            </div>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-user-tag"></i>
                Display Information
              </h4>
              <p class="settings-group-desc">Customize how others see you in the chat.</p>

              <div class="settings-field">
                <label class="settings-label">Display Name</label>
                <input id="displayName" class="settings-input" placeholder="Your display name">
              </div>

              <div class="settings-field">
                <label class="settings-label">Status Message</label>
                <input id="statusMessage" class="settings-input" placeholder="What's on your mind?">
              </div>

              <button class="settings-btn" onclick="updateProfile()">
                <i class="fas fa-save"></i>
                Save Profile
              </button>
            </div>
          </div>

          <!-- Appearance Section -->
          <div id="appearance-section" class="settings-section">
            <h3 class="settings-section-title">
              <i class="fas fa-palette"></i>
              Appearance
            </h3>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-moon"></i>
                Theme
              </h4>
              <p class="settings-group-desc">Choose your preferred theme for the chat interface.</p>

              <div class="theme-grid">
                <div class="theme-circle theme-default selected" onclick="selectTheme('default')" title="Default Dark"></div>
                <div class="theme-circle theme-mint" onclick="selectTheme('mint')" title="Mint Fresh"></div>
                <div class="theme-circle theme-sunset" onclick="selectTheme('sunset')" title="Sunset Orange"></div>
                <div class="theme-circle theme-ocean" onclick="selectTheme('ocean')" title="Ocean Blue"></div>
                <div class="theme-circle theme-forest" onclick="selectTheme('forest')" title="Forest Green"></div>
                <div class="theme-circle theme-rose" onclick="selectTheme('rose')" title="Rose Pink"></div>
                <div class="theme-circle theme-lavender" onclick="selectTheme('lavender')" title="Lavender Purple"></div>
                <div class="theme-circle theme-arctic" onclick="selectTheme('arctic')" title="Arctic Blue"></div>
                <div class="theme-circle theme-warm" onclick="selectTheme('warm')" title="Warm Beige"></div>
                <div class="theme-circle theme-cosmic" onclick="selectTheme('cosmic')" title="Cosmic Purple"></div>
                <div class="theme-circle theme-emerald" onclick="selectTheme('emerald')" title="Emerald Green"></div>
                <div class="theme-circle theme-volcano" onclick="selectTheme('volcano')" title="Volcano Red"></div>
                <div class="theme-circle theme-deep" onclick="selectTheme('deep')" title="Deep Blue"></div>
                <div class="theme-circle theme-autumn" onclick="selectTheme('autumn')" title="Autumn Brown"></div>
                <div class="theme-circle theme-neon" onclick="selectTheme('neon')" title="Neon Blue"></div>
              </div>
            </div>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-text-width"></i>
                Text & Display
              </h4>
              <p class="settings-group-desc">Adjust text size and display preferences.</p>

              <div class="settings-field">
                <label class="settings-label">Message Font Size</label>
                <input type="range" min="12" max="20" value="16" class="settings-input" id="fontSize">
              </div>

              <div class="settings-field">
                <label class="settings-label">Compact Mode</label>
                <input type="checkbox" id="compactMode"> Enable compact message display
              </div>
            </div>
          </div>

          <!-- Devices Section -->
          <div id="devices-section" class="settings-section">
            <h3 class="settings-section-title">
              <i class="fas fa-desktop"></i>
              Devices & Sessions
            </h3>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-laptop"></i>
                Active Sessions
              </h4>
              <p class="settings-group-desc">Manage your active login sessions across different devices.</p>

              <div class="device-item">
                <div class="device-info">
                  <div class="device-icon">
                    <i class="fas fa-laptop"></i>
                  </div>
                  <div class="device-details">
                    <h4>Current Device</h4>
                    <p>Chrome on Windows • Last active: Now</p>
                  </div>
                </div>
                <span class="device-current">Current Session</span>
              </div>

              <div class="device-item">
                <div class="device-info">
                  <div class="device-icon">
                    <i class="fas fa-mobile-alt"></i>
                  </div>
                  <div class="device-details">
                    <h4>Mobile Device</h4>
                    <p>Safari on iPhone • Last active: 2 hours ago</p>
                  </div>
                </div>
                <button class="settings-btn secondary">
                  <i class="fas fa-sign-out-alt"></i>
                  Sign Out
                </button>
              </div>
            </div>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-shield-alt"></i>
                Security Options
              </h4>
              <p class="settings-group-desc">Additional security features for your account.</p>

              <div class="settings-field">
                <label class="settings-label">Auto-logout inactive sessions</label>
                <input type="checkbox" id="autoLogout" checked> Sign out inactive devices after 7 days
              </div>

              <button class="settings-btn" onclick="signOutAllDevices()">
                <i class="fas fa-sign-out-alt"></i>
                Sign Out All Other Devices
              </button>
            </div>
          </div>

          <!-- Privacy Section -->
          <div id="privacy-section" class="settings-section">
            <h3 class="settings-section-title">
              <i class="fas fa-shield-alt"></i>
              Privacy & Safety
            </h3>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-eye"></i>
                Visibility
              </h4>
              <p class="settings-group-desc">Control who can see your information and activity.</p>

              <div class="settings-field">
                <label class="settings-label">Show online status</label>
                <input type="checkbox" id="showOnlineStatus" checked> Let others see when you're online
              </div>

              <div class="settings-field">
                <label class="settings-label">Show last seen</label>
                <input type="checkbox" id="showLastSeen"> Show when you were last active
              </div>
            </div>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-ban"></i>
                Blocked Users
              </h4>
              <p class="settings-group-desc">Manage users you've blocked from contacting you.</p>

              <p style="color: var(--text-muted); font-style: italic;">No blocked users</p>
            </div>
          </div>

          <!-- Notifications Section -->
          <div id="notifications-section" class="settings-section">
            <h3 class="settings-section-title">
              <i class="fas fa-bell"></i>
              Notifications
            </h3>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-desktop"></i>
                Desktop Notifications
              </h4>
              <p class="settings-group-desc">Control when you receive browser notifications.</p>

              <div class="settings-field">
                <label class="settings-label">Enable notifications</label>
                <input type="checkbox" id="enableNotifications"> Receive notifications for new messages
              </div>

              <div class="settings-field">
                <label class="settings-label">Sound alerts</label>
                <input type="checkbox" id="soundAlerts"> Play sound for notifications
              </div>
            </div>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-volume-up"></i>
                Sound Settings
              </h4>
              <p class="settings-group-desc">Customize sound preferences for the chat.</p>

              <div class="settings-field">
                <label class="settings-label">Message sound</label>
                <input type="checkbox" id="messageSound" checked> Play sound when receiving messages
              </div>

              <div class="settings-field">
                <label class="settings-label">Join/Leave sound</label>
                <input type="checkbox" id="joinLeaveSound"> Play sound when users join or leave
              </div>
            </div>
          </div>

          <!-- Admin Moderation Section -->
          <div id="moderation-section" class="settings-section admin-only" style="display: none;">
            <h3 class="settings-section-title">
              <i class="fas fa-gavel"></i>
              Content Moderation
            </h3>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-ban"></i>
                Bad Words Filter
              </h4>
              <p class="settings-group-desc">Manage the list of words that will be automatically filtered from chat messages.</p>

              <div class="settings-field">
                <label class="settings-label">Add New Bad Word</label>
                <div class="input-group">
                  <input id="newBadWord" class="settings-input" placeholder="Enter word to filter..." maxlength="50">
                  <button class="settings-btn" onclick="addBadWord()">
                    <i class="fas fa-plus"></i>
                    Add
                  </button>
                </div>
              </div>

              <div class="bad-words-list-container">
                <h5 class="bad-words-title">Current Bad Words List (<span id="badWordsCount">0</span>)</h5>
                <div id="badWordsList" class="bad-words-list">
                  <!-- Bad words will be populated here -->
                </div>
              </div>
            </div>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-cogs"></i>
                Filter Settings
              </h4>
              <p class="settings-group-desc">Configure how the bad words filter works.</p>

              <div class="settings-field">
                <label class="settings-label">Filter Action</label>
                <select id="filterAction" class="settings-select">
                  <option value="replace">Replace with asterisks (***)</option>
                  <option value="remove">Remove the word completely</option>
                  <option value="block">Block message entirely</option>
                </select>
              </div>

              <div class="settings-field">
                <label class="settings-label">Case Sensitive</label>
                <input type="checkbox" id="caseSensitive"> Match exact case only
              </div>

              <div class="settings-field">
                <label class="settings-label">Whole Words Only</label>
                <input type="checkbox" id="wholeWordsOnly" checked> Only match complete words
              </div>

              <button class="settings-btn" onclick="saveFilterSettings()">
                <i class="fas fa-save"></i>
                Save Filter Settings
              </button>
            </div>

            <div class="settings-group">
              <h4 class="settings-group-title">
                <i class="fas fa-chart-bar"></i>
                Moderation Stats
              </h4>
              <p class="settings-group-desc">Statistics about filtered content.</p>

              <div class="moderation-stats">
                <div class="stat-item">
                  <div class="stat-number" id="filteredToday">0</div>
                  <div class="stat-label">Filtered Today</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="filteredTotal">0</div>
                  <div class="stat-label">Total Filtered</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="totalBadWords">0</div>
                  <div class="stat-label">Bad Words Count</div>
                </div>
              </div>

              <button class="settings-btn secondary" onclick="resetModerationStats()">
                <i class="fas fa-refresh"></i>
                Reset Statistics
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
